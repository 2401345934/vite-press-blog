import{_ as l,o as i,c as r,J as s,w as c,m as a,a as t,aa as b,E as n}from"./chunks/framework.DJCjJe2w.js";const q=JSON.parse('{"title":"GitLab CI ä»å…¥é—¨åˆ°å®è·µ","description":"","frontmatter":{"createTime":"2022/11/10","tag":"å·¥ç¨‹åŒ–,cicd"},"headers":[],"relativePath":"engineering/cicd/gitlab-cicd/index.md","filePath":"engineering/cicd/gitlab-cicd/index.md","lastUpdated":1668091633000}'),o={name:"engineering/cicd/gitlab-cicd/index.md"},u=a("h1",{id:"gitlab-ci-ä»å…¥é—¨åˆ°å®è·µ",tabindex:"-1"},[t("GitLab CI ä»å…¥é—¨åˆ°å®è·µ "),a("a",{class:"header-anchor",href:"#gitlab-ci-ä»å…¥é—¨åˆ°å®è·µ","aria-label":'Permalink to "GitLab CI ä»å…¥é—¨åˆ°å®è·µ"'},"â€‹")],-1),m=b(`<h2 id="ä¸€ã€gitlab-ci-æ˜¯ä»€ä¹ˆ" tabindex="-1">ä¸€ã€Gitlab CI æ˜¯ä»€ä¹ˆï¼Ÿ <a class="header-anchor" href="#ä¸€ã€gitlab-ci-æ˜¯ä»€ä¹ˆ" aria-label="Permalink to &quot;ä¸€ã€Gitlab CI æ˜¯ä»€ä¹ˆï¼Ÿ&quot;">â€‹</a></h2><p>ç°ä»£æŒç»­çš„è½¯ä»¶å¼€å‘å¯¼è‡´äº†å¼€å‘è€…éœ€è¦æŒç»­çš„build, test å’Œ deploy é‡å¤çš„ä»£ç æ›´æ”¹ï¼Œè¿™äº›é‡å¤çš„è¿‡ç¨‹éå¸¸çš„ç¹çï¼Œä½†æ˜¯å¯¹ä¿è¯ä»£ç æŒç»­æ›´æ–°è¿­ä»£æ¥è¯´åˆéå¸¸çš„é‡è¦ã€‚æ­¤æ—¶ä¾¿éœ€è¦ä¸€ç§éäººä¸ºæ‰‹åŠ¨çš„æ–¹æ³•æ¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨å®Œæˆè¿™äº›é‡å¤çš„å·¥ä½œã€‚</p><p>è¿™ä¸ªè‡ªåŠ¨å®Œæˆå·¥ä½œçš„ç†å¿µè¢«ç§°ä¸ºCI/CD. åœ¨è¿™é‡ŒGitlab CI/CDå°±æ˜¯Gitlabå®˜æ–¹å‘å¸ƒçš„ä¸€ç§è‡ªåŠ¨æµæ°´çº¿å¸®åŠ©å¼€å‘è€…å®Œæˆé‡å¤æ€§å·¥ä½œçš„ä¸€ä¸ªæœåŠ¡ã€‚</p><p>æ¯”å¦‚å­—èŠ‚æŸå†…éƒ¨å·¥å…·E*** CI åˆ™æ˜¯åœ¨Gitlab CI å’Œ Codebase CIçš„åŸºç¡€ä¸Šæ”¹è¿›ï¼Œå¢åŠ æ›´ç»†èŠ‚çš„ä½¿ç”¨åœºæ™¯åˆ†ç±»ï¼Œå¯¹monorepoæ”¯æŒæ›´åŠ çš„å‹å¥½ã€‚</p><h2 id="äºŒã€å¦‚ä½•ä½¿ç”¨" tabindex="-1">äºŒã€å¦‚ä½•ä½¿ç”¨ï¼Ÿ <a class="header-anchor" href="#äºŒã€å¦‚ä½•ä½¿ç”¨" aria-label="Permalink to &quot;äºŒã€å¦‚ä½•ä½¿ç”¨ï¼Ÿ&quot;">â€‹</a></h2><h3 id="gitlab-ciçš„ä½¿ç”¨ä¸»è¦éœ€è¦2å¤§æ­¥éª¤" tabindex="-1">Gitlab CIçš„ä½¿ç”¨ä¸»è¦éœ€è¦2å¤§æ­¥éª¤ <a class="header-anchor" href="#gitlab-ciçš„ä½¿ç”¨ä¸»è¦éœ€è¦2å¤§æ­¥éª¤" aria-label="Permalink to &quot;Gitlab CIçš„ä½¿ç”¨ä¸»è¦éœ€è¦2å¤§æ­¥éª¤&quot;">â€‹</a></h3><h3 id="æ­¥éª¤ä¸€-é…ç½®runner" tabindex="-1">æ­¥éª¤ä¸€ï¼šé…ç½®runner <a class="header-anchor" href="#æ­¥éª¤ä¸€-é…ç½®runner" aria-label="Permalink to &quot;æ­¥éª¤ä¸€ï¼šé…ç½®runner&quot;">â€‹</a></h3><blockquote><p>æˆ‘ä»¬å¯ä»¥ç®€å•çš„æŠŠGitlab runnerç»™ç†è§£æˆ<code>.gitlab-ci.yml</code> æ–‡ä»¶å†…å®¹çš„æ‰§è¡Œè€…ï¼Œ<code>.gitlab-ci.yml</code> å‘Šè¯‰äº†Gitlab runnerå»åšä»€ä¹ˆã€‚</p><p>Gitlab runnerä¸æ˜¯ä¸€ä¸ªé…ç½®é¡¹ï¼Œå®ƒæ˜¯éœ€è¦ä¸“é—¨éƒ¨ç½²çš„ï¼Œæ¯”å¦‚ç”¨dockeréƒ¨ç½²ä¸€ä¸ªrunneré•œåƒåˆ°å¯ä»¥è¿æ¥å†…ç½‘çš„å®¹å™¨ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å…¬å¸å†…é…å¥½çš„shared runners.</p></blockquote><p>ä½¿ç”¨å…¬å…±çš„runnerï¼Œæˆ–è€…è‡ªå·±åˆ›å»ºä¸€ä¸ªrunner</p><ol><li><h4 id="ä½¿ç”¨shared-runner" tabindex="-1">ä½¿ç”¨shared runner <a class="header-anchor" href="#ä½¿ç”¨shared-runner" aria-label="Permalink to &quot;ä½¿ç”¨shared runner&quot;">â€‹</a></h4></li></ol><p>æ— éœ€å¤šä½™æ“ä½œï¼Œè¯·ç¡®ä¿shared runneré€‰é¡¹è¢«enableäº†å³å¯<strong>ç›´æ¥ä½¿ç”¨</strong>å…¬å…±runnerã€‚ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/06f534c890984ad7a97475bca98e2d9c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><ol start="2"><li><h4 id="è‡ªå·±é…ç½®runner" tabindex="-1">è‡ªå·±é…ç½®runner <a class="header-anchor" href="#è‡ªå·±é…ç½®runner" aria-label="Permalink to &quot;è‡ªå·±é…ç½®runner&quot;">â€‹</a></h4></li></ol><blockquote><p>éƒ¨ç½²Gitlab runnerå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.gitlab.com%2Frunner%2Finstall%2Fdocker.html" title="https://docs.gitlab.com/runner/install/docker.html" target="_blank" rel="noreferrer">Run GitLab Runner in a container | GitLab</a></p><p>å…³è”runneråˆ°gitlabå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.gitlab.com%2Frunner%2Fregister%2Findex.html%23docker" title="https://docs.gitlab.com/runner/register/index.html#docker" target="_blank" rel="noreferrer">Registering runners | GitLab</a></p></blockquote><h4 id="a-å®‰è£…docker" tabindex="-1">A. å®‰è£…docker <a class="header-anchor" href="#a-å®‰è£…docker" aria-label="Permalink to &quot;A. å®‰è£…docker&quot;">â€‹</a></h4><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">brew install </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">--</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cask docker</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="b-å¯åŠ¨gitlab-runner-container" tabindex="-1">B. å¯åŠ¨Gitlab runner container <a class="header-anchor" href="#b-å¯åŠ¨gitlab-runner-container" aria-label="Permalink to &quot;B. å¯åŠ¨Gitlab runner container&quot;">â€‹</a></h4><p>èµ·ä¸€ä¸ªdocker containeræ¥æ‰§è¡ŒGitlab Runneré•œåƒ</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  docker run -d --name gitlab-runner --restart always \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   -v /Users/Shared/gitlab-runner/config:/etc/gitlab-runner \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   -v /var/run/docker.sock:/var/run/docker.sock \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   gitlab/gitlab-runner:latest</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dca7cb3c3a8e4f5f8de42d872f95bf1e~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p><strong>Note</strong>: macOSä¸Šé¢çš„å…±äº«æ–‡ä»¶å¤¹è¦è®¾ç½®ä¸º<code>/Users/Shared/</code>è€Œä¸æ˜¯<code>/srv</code></p><h4 id="c-æ³¨å†Œrunneråˆ°gitlab" tabindex="-1">C. æ³¨å†Œrunneråˆ°Gitlab <a class="header-anchor" href="#c-æ³¨å†Œrunneråˆ°gitlab" aria-label="Permalink to &quot;C. æ³¨å†Œrunneråˆ°Gitlab&quot;">â€‹</a></h4><p>åªç”¨dockerèµ·ä¸€ä¸ªgitlab runnerä¸èƒ½å°†æˆ‘ä»¬å½“å‰ä½¿ç”¨çš„gitlab repositoryå’Œä¸Šä¸€æ­¥åˆ›å»ºçš„runnerè¿›è¡Œå…³è”ã€‚åœ¨æ­¤éœ€è¦å°†å…¶è¿›è¡Œç›¸äº’å…³è”ï¼Œå°†runneræ³¨å†Œåˆ°æˆ‘ä»¬çš„gitlab repository</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/801f5c22e20b4adfbd57193dbe25d03d~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>ä½¿ç”¨ä¸Šå›¾å¾—åˆ°çš„URLå’Œtokenå»æ›¿æ¢ä¸‹é¢æŒ‡ä»¤çš„<code>--url</code>å’Œ<code>--registration-token</code></p><p><code>--tag-list</code> ä¸ºå½“å‰runnerçš„æ ‡ç­¾ï¼Œåœ¨é…ç½®æµæ°´çº¿jobçš„æ—¶å€™ä½¿ç”¨ï¼Œåœ¨æ­¤å¯éšæ„é…ç½®ä¸åŒçš„æ ‡ç­¾å</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker run --rm -v /Users/Shared/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner register \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --non-interactive \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --executor &quot;docker&quot; \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --docker-image alpine:latest \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --url &quot;https://gitlab.com/&quot; \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --registration-token &quot;wc-Reg7qUpGRB4Lw3q9Y&quot; \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --description &quot;gitlabâ€”cicd-runner&quot; \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --tag-list &quot;yehanli,liyehan&quot; \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --run-untagged=&quot;true&quot; \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --locked=&quot;false&quot; \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --access-level=&quot;not_protected&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eae0169c8551445ca5e0b055dba6df3c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>è‡³æ­¤ï¼ŒGitlab runnerå’Œé…ç½®å‡å·²æˆåŠŸï¼Œæ‰“å¼€setting/CICDé¡µé¢å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æç¤ºï¼š</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/03fac75871da4cb687f96734e6ab2da3~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>åœ¨dockerä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°æ­£åœ¨è¿è¡Œçš„runner(å¦‚ä¸‹):</p><p>æš‚æ—¶æ— æ³•åœ¨é£ä¹¦æ–‡æ¡£å¤–å±•ç¤ºæ­¤å†…å®¹</p><h3 id="æ­¥éª¤äºŒ-åˆ›å»º-gitlab-ci-ymlæ–‡ä»¶" tabindex="-1">æ­¥éª¤äºŒï¼šåˆ›å»º<code>.gitlab-ci.yml</code>æ–‡ä»¶ <a class="header-anchor" href="#æ­¥éª¤äºŒ-åˆ›å»º-gitlab-ci-ymlæ–‡ä»¶" aria-label="Permalink to &quot;æ­¥éª¤äºŒï¼šåˆ›å»º\`.gitlab-ci.yml\`æ–‡ä»¶&quot;">â€‹</a></h3><hr><p>åœ¨mono repoçš„æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªæ–‡ä»¶, å‘½åä¸º<code>.gitlab-ci.yml</code>, å¹¶å°†å…¶pushåˆ°masteråˆ†æ”¯ã€‚</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>git add .gitlab-ci.yml</span></span>
<span class="line"><span>git commit -m &quot;Add .gitlab-ci.yml&quot;</span></span>
<span class="line"><span>git push origin master</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>Note:</strong></p><ul><li>åœ¨è¾ƒä½gitlabç‰ˆæœ¬(æ¯”å¦‚11.4)ï¼Œå¦‚æœåœ¨masterä¸»åˆ†æ”¯ä¸‹æ²¡æœ‰<code>.gitlab-ci.yml</code>çš„è¯ï¼Œåœ¨Gitlabå·¦ä¾§çš„å¯¼èˆªæ ä¸ä¼šæœ‰Gitlab Runnerè¿™ä¸ªtabã€‚</li></ul><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/26b56339a1554678905efc940457c6c5~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><ul><li>åœ¨é¡¹ç›®çš„setting/CI/CD/General pipelinesä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰è®¾ç½®CIè®¾ç½®æ–‡ä»¶çš„è·¯å¾„ï¼Œé»˜è®¤å¦‚ä¸‹</li></ul><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c48c917d6d8c4cc8a41bf7d0ad635dbf~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><h2 id="ä¸‰ã€å¦‚ä½•ç¼–å†™-gitlab-ci-ymlæ–‡ä»¶" tabindex="-1">ä¸‰ã€å¦‚ä½•ç¼–å†™.gitlab-ci.ymlæ–‡ä»¶ï¼Ÿ <a class="header-anchor" href="#ä¸‰ã€å¦‚ä½•ç¼–å†™-gitlab-ci-ymlæ–‡ä»¶" aria-label="Permalink to &quot;ä¸‰ã€å¦‚ä½•ç¼–å†™.gitlab-ci.ymlæ–‡ä»¶ï¼Ÿ&quot;">â€‹</a></h2><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å…ˆæ¥ç†Ÿæ‚‰ä¸‹yamlçš„å¸¸è§å†™æ³•ï¼Œä»¥åŠå¯¹æ¯”ä¸‹å®ƒä¸jsonæœ‰ä»€ä¹ˆä¸åŒã€‚</p><p>Yaml Syntaxå†™æ³•è¯¦æƒ…å…·ä½“è¯·è§ =&gt; <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.ansible.com%2Fansible%2Flatest%2Freference_appendices%2FYAMLSyntax.html" title="https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html" target="_blank" rel="noreferrer">YAML Syntax â€’ Ansible Documentation</a></p><h3 id="yamlè¯­æ³•" tabindex="-1">YAMLè¯­æ³• <a class="header-anchor" href="#yamlè¯­æ³•" aria-label="Permalink to &quot;YAMLè¯­æ³•&quot;">â€‹</a></h3><h4 id="æ•°ç»„å†™æ³•" tabindex="-1">æ•°ç»„å†™æ³• <a class="header-anchor" href="#æ•°ç»„å†™æ³•" aria-label="Permalink to &quot;æ•°ç»„å†™æ³•&quot;">â€‹</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>{</span></span>
<span class="line"><span>    &quot;array&quot;: [&quot;red&quot;, &quot;blue&quot;, &quot;yellow&quot;]</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>è½¬åŒ–ä¸ºyamlä¸º</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>array:</span></span>
<span class="line"><span>  - red</span></span>
<span class="line"><span>  - blue</span></span>
<span class="line"><span>  - yellow</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="å¯¹è±¡å†™æ³•" tabindex="-1">å¯¹è±¡å†™æ³• <a class="header-anchor" href="#å¯¹è±¡å†™æ³•" aria-label="Permalink to &quot;å¯¹è±¡å†™æ³•&quot;">â€‹</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>{</span></span>
<span class="line"><span>  &quot;student1&quot;: {</span></span>
<span class="line"><span>    &quot;name&quot;: &quot;å°æ˜&quot;</span></span>
<span class="line"><span>  },</span></span>
<span class="line"><span>  &quot;array&quot;: [&quot;red&quot;, &quot;blue&quot;, &quot;yellow&quot;],</span></span>
<span class="line"><span>  &quot;student2&quot;: {</span></span>
<span class="line"><span>    &quot;name&quot;: &quot;å°æ˜&quot;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>è½¬åŒ–ä¸ºyamlä¸º</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span># æˆ‘æ˜¯æ³¨é‡Š</span></span>
<span class="line"><span>student1:</span></span>
<span class="line"><span>  name: å°æ˜</span></span>
<span class="line"><span>array:</span></span>
<span class="line"><span>  - red</span></span>
<span class="line"><span>  - blue</span></span>
<span class="line"><span>  - yellow</span></span>
<span class="line"><span>student2:</span></span>
<span class="line"><span>  name: å°æ˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>yamlä¸­ä¸åƒjsoné‚£æ ·æ— æ³•æ³¨é‡Šï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>#</code>è¿›è¡Œæ³¨é‡Š</li></ul><h3 id="æµæ°´çº¿ç¯èŠ‚æ¢³ç†" tabindex="-1">æµæ°´çº¿ç¯èŠ‚æ¢³ç† <a class="header-anchor" href="#æµæ°´çº¿ç¯èŠ‚æ¢³ç†" aria-label="Permalink to &quot;æµæ°´çº¿ç¯èŠ‚æ¢³ç†&quot;">â€‹</a></h3><p>æµæ°´çº¿çš„æµç¨‹ï¼Œæ ¹æ®é…ç½®çš„.gitlab-ci.ymlæ–‡ä»¶å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªç¯èŠ‚ï¼š</p><ol><li><p>åœ¨å•ä¸ªçš„æµæ°´çº¿ä»»åŠ¡æ‰§è¡Œä¹‹å‰è¿›è¡Œé…ç½®</p></li><li><p>å®šä¹‰å•ä¸ªæµæ°´çº¿ä»»åŠ¡(job)ï¼Œå¹¶å¯¹æ­¤ä»»åŠ¡è¿›è¡Œé’ˆå¯¹é…ç½®</p></li></ol><h3 id="ç»“æ„å›¾" tabindex="-1">ç»“æ„å›¾ <a class="header-anchor" href="#ç»“æ„å›¾" aria-label="Permalink to &quot;ç»“æ„å›¾&quot;">â€‹</a></h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/733d1e7793a44d97bbb402d7e4a83c48~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>å•ä¸ªæµæ°´çº¿ä»»åŠ¡çš„å½¢å¼å¯ä»¥å‚è€ƒå¦‚ä¸‹ç¤ºä¾‹ï¼Œå…·ä½“å­—æ®µé‡Šä¹‰å¯ä»¥æš‚æ—¶å¿½ç•¥ï¼Œä¼šåœ¨ä¹‹åè¯¦è§£ï¼š</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># è¿™ä¸ªmy_jobçš„ä»»åŠ¡åæ˜¯å¯ä»¥è‡ªå®šä¹‰èµ·çš„</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">my_job</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  only</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">master</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  tags</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">yehanli</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">echo &#39;job ========= å®Œæˆ&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">build</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  retry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="gitlab-ci-å…³é”®å­—" tabindex="-1">Gitlab-CI å…³é”®å­— <a class="header-anchor" href="#gitlab-ci-å…³é”®å­—" aria-label="Permalink to &quot;Gitlab-CI å…³é”®å­—&quot;">â€‹</a></h2><blockquote><p>Gitlab CIçš„å…³é”®å­—æœ‰å¾ˆå¤šï¼Œä½†å®é™…å¸¸ç”¨çš„åªæœ‰è¾ƒå°ä¸€éƒ¨åˆ†ã€‚åœ¨æ­¤éƒ¨åˆ†ä¼šå¯¹å¸¸ç”¨å…³é”®å­—è¿›è¡Œè¯¦è§£ã€‚</p><p>å¦‚æœéœ€è¦ç‰¹æ®Šé…ç½®å¯å‚è€ƒå…³é”®å­—æ–‡æ¡£=&gt; <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.gitlab.com%2Fee%2Fci%2Fyaml%2F" title="https://docs.gitlab.com/ee/ci/yaml/" target="_blank" rel="noreferrer">Keyword reference for the <code>.gitlab-ci.yml</code> file |</a> <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.gitlab.com%2Fee%2Fci%2Fyaml%2F" title="https://docs.gitlab.com/ee/ci/yaml/" target="_blank" rel="noreferrer">GitLab</a></p></blockquote><p>é¦–å…ˆè®©æˆ‘ä»¬å…ˆæ¥ä»‹ç»ä¸‹å…³é”®å­—ï¼Œç„¶åå†çœ‹ä¸€ä»½å®Œæ•´çš„é…ç½®demoè¿›è¡Œè¯¦è§£ã€‚</p><h3 id="script" tabindex="-1">script <a class="header-anchor" href="#script" aria-label="Permalink to &quot;script&quot;">â€‹</a></h3><p>éœ€è¦è¢«è¿è¡Œçš„è„šæœ¬ã€‚ä»¥æ•°ç»„å½¢å¼é…ç½®ã€‚</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>pipeline_job:</span></span>
<span class="line"><span>  ......</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - cd &lt;æ–‡ä»¶å¤¹ç›®å½•è·¯å¾„&gt;</span></span>
<span class="line"><span>    - npm install</span></span>
<span class="line"><span>    - npm build</span></span>
<span class="line"><span>  ......</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="before-script" tabindex="-1">before_script <a class="header-anchor" href="#before-script" aria-label="Permalink to &quot;before\\_script&quot;">â€‹</a></h3><p>åœ¨æ‰€æœ‰çš„æµæ°´çº¿ä»»åŠ¡æ‰§è¡Œä¹‹å‰éœ€è¦æ‰§è¡Œçš„è„šæœ¬ï¼Œæˆ–è€…å•ä¸ªæµæ°´çº¿ä»»åŠ¡ä¸­çš„scriptæ‰§è¡Œä¹‹å‰æ‰§è¡ŒæŸäº›script</p><h3 id="variableså˜é‡" tabindex="-1">variableså˜é‡ <a class="header-anchor" href="#variableså˜é‡" aria-label="Permalink to &quot;variableså˜é‡&quot;">â€‹</a></h3><p>åœ¨Gitlab-CIä¸­ï¼Œå˜é‡å¤§è‡´å¯åˆ†ä¸ºä¸‰ç±»ï¼š</p><ol><li><p>Gitlabç»™æˆ‘ä»¬é¢„å…ˆå®šä¹‰çš„å˜é‡ï¼Œæ¯”å¦‚<code>CI_COMMIT_BRANCH</code>.</p><ol><li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.gitlab.com%2Fee%2Fci%2Fvariables%2Fpredefined_variables.html" title="https://docs.gitlab.com/ee/ci/variables/predefined_variables.html" target="_blank" rel="noreferrer">Predefined variables reference | GitLab</a></li></ol></li><li><p>Setting =&gt; Gitlab CI/CD =&gt; variablesä¸­å®šä¹‰çš„å˜é‡</p></li></ol><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a79a7bf40eb64a4283eaeae26649b5ca~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><ol start="3"><li>åœ¨.gitlab-ci.ymlä¸­å®šä¹‰çš„å˜é‡(å¦‚ä¸‹ç¤ºä¾‹) <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.gitlab.com%2Fee%2Fci%2Fvariables%2Findex.html%23create-a-custom-cicd-variable-in-the-gitlab-ciyml-file" title="https://docs.gitlab.com/ee/ci/variables/index.html#create-a-custom-cicd-variable-in-the-gitlab-ciyml-file" target="_blank" rel="noreferrer">GitLab</a> <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.gitlab.com%2Fee%2Fci%2Fvariables%2Findex.html%23create-a-custom-cicd-variable-in-the-gitlab-ciyml-file" title="https://docs.gitlab.com/ee/ci/variables/index.html#create-a-custom-cicd-variable-in-the-gitlab-ciyml-file" target="_blank" rel="noreferrer"></a><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.gitlab.com%2Fee%2Fci%2Fvariables%2Findex.html%23create-a-custom-cicd-variable-in-the-gitlab-ciyml-file" title="https://docs.gitlab.com/ee/ci/variables/index.html#create-a-custom-cicd-variable-in-the-gitlab-ciyml-file" target="_blank" rel="noreferrer">CI</a><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.gitlab.com%2Fee%2Fci%2Fvariables%2Findex.html%23create-a-custom-cicd-variable-in-the-gitlab-ciyml-file" title="https://docs.gitlab.com/ee/ci/variables/index.html#create-a-custom-cicd-variable-in-the-gitlab-ciyml-file" target="_blank" rel="noreferrer">/</a><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.gitlab.com%2Fee%2Fci%2Fvariables%2Findex.html%23create-a-custom-cicd-variable-in-the-gitlab-ciyml-file" title="https://docs.gitlab.com/ee/ci/variables/index.html#create-a-custom-cicd-variable-in-the-gitlab-ciyml-file" target="_blank" rel="noreferrer">CD</a> <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.gitlab.com%2Fee%2Fci%2Fvariables%2Findex.html%23create-a-custom-cicd-variable-in-the-gitlab-ciyml-file" title="https://docs.gitlab.com/ee/ci/variables/index.html#create-a-custom-cicd-variable-in-the-gitlab-ciyml-file" target="_blank" rel="noreferrer">variables | GitLab</a></li></ol><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>variables:</span></span>
<span class="line"><span>  TEST_VAR: &quot;All jobs can use this variable&#39;s value&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>job1:</span></span>
<span class="line"><span>  variables:</span></span>
<span class="line"><span>    TEST_VAR_JOB: &quot;Only job1 can use this variable&#39;s value&quot;</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - echo &quot;$TEST_VAR&quot;</span></span>
<span class="line"><span>  ......</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="image" tabindex="-1">image <a class="header-anchor" href="#image" aria-label="Permalink to &quot;image&quot;">â€‹</a></h3><p>CIæµæ°´çº¿è¿è¡Œç¯å¢ƒçš„dockeré•œåƒ(ä»»ä½•ç›¸å…³çš„ä»£ç è¿è¡Œç¯å¢ƒé•œåƒçš†å¯)ï¼Œæ¯”å¦‚å­—èŠ‚æŸå†…éƒ¨å·¥å…·e***çš„é•œåƒï¼Œé‡Œé¢è£…äº†nvmç®¡ç†å™¨.</p><ul><li>æ¯”è¾ƒå¸¸ç”¨çš„æœ‰ï¼šnode, python, java, etc...</li></ul><h3 id="stages" tabindex="-1">stages <a class="header-anchor" href="#stages" aria-label="Permalink to &quot;stages&quot;">â€‹</a></h3><p>Gitlab CIå…è®¸æˆ‘ä»¬è¿›è¡Œè‡ªå®šä¹‰çš„æµæ°´çº¿é˜¶æ®µé…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥å°†è‡ªå·±çš„æµæ°´çº¿è‡ªæˆ‘åˆ’åˆ†ä¸ºè‹¥å¹²<code>stages</code>ï¼Œç„¶ååœ¨ä¸åŒçš„stageæ¥åšä¸åŒçš„äº‹ã€‚ï¼ˆç¨åä¼šæœ‰ç¤ºä¾‹ï¼‰</p><p>stagesä¼šä¾æ¬¡æ‰§è¡Œï¼Œå¦‚æœå‰ä¸€ä¸ªstageçš„ä»»åŠ¡æ²¡æœ‰è¿è¡Œå®Œï¼Œåé¢çš„stageä¸ä¼šè¢«è§¦å‘ã€‚</p><p>ä¸€æ—¦æœ‰ä¸€ä¸ªstageä¸­çš„ä»»åŠ¡failæ‰äº†ï¼Œä¸‹ä¸€ä¸ªstageçš„ä»»åŠ¡ä¾¿ä¸ä¼šæ‰§è¡Œã€‚å¦‚æœå½“å‰stageå®šä¹‰äº†å¤šä¸ªä»»åŠ¡ï¼Œé‚£ä¹ˆå…¶ä¸­ä¸€ä¸ªä»»åŠ¡å¤±è´¥ï¼Œå¦å¤–ä¸€ä¸ªä»»åŠ¡è¿˜æ˜¯ä¼šè¢«ç»§ç»­æ‰§è¡Œã€‚</p><p>ä»¥ä¸‹ä¸ºè‡ªå®šä¹‰çš„stagesï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>stages:</span></span>
<span class="line"><span>  - first_stage</span></span>
<span class="line"><span>  - second_stage</span></span>
<span class="line"><span>  - third_stage</span></span>
<span class="line"><span>  - fourth_stage</span></span>
<span class="line"><span>  - fifth_stage</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰stagesï¼Œé‚£ä¹ˆé»˜è®¤çš„stagesä¸º<code>.pre =&gt; build =&gt; test =&gt; deploy =&gt; .post</code></p><p>(è‡ªå®šä¹‰stagesä¼š<strong>é‡å†™</strong>é™¤äº†<code>.pre</code>, <code>.post</code>ä¹‹å¤–æ‰€æœ‰çš„é»˜è®¤stages)</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>stages:</span></span>
<span class="line"><span>  - .pre # æ‰§è¡Œåœ¨æ‰€æœ‰çš„stagesä¹‹å‰</span></span>
<span class="line"><span>  - build</span></span>
<span class="line"><span>  - test</span></span>
<span class="line"><span>  - deploy</span></span>
<span class="line"><span>  - .post # æ‰§è¡Œåœ¨æ‰€æœ‰çš„stagesä¹‹å</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>Note</strong>: build ä¸­å¦‚æœå®šä¹‰å¤šä¸ªjobsï¼Œè¿™äº›jobsæ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œåˆ«çš„stageä¸­çš„ä¸ºä¾æ¬¡æ‰§è¡Œã€‚</p><h3 id="stage" tabindex="-1">stage <a class="header-anchor" href="#stage" aria-label="Permalink to &quot;stage&quot;">â€‹</a></h3><p>stageä¸ºstagesçš„ä¸€ä¸ªå­é¡¹ï¼Œåœ¨æˆ‘ä»¬è‡ªå®šä¹‰å•ä¸ªæµæ°´çº¿ä»»åŠ¡æ—¶å¯ä»¥é…ç½®</p><h3 id="cache" tabindex="-1">cache <a class="header-anchor" href="#cache" aria-label="Permalink to &quot;cache&quot;">â€‹</a></h3><p>ç¼“å­˜å¤šä¸ªæµæ°´çº¿ä»»åŠ¡ä¹‹é—´å…±ç”¨çš„æ–‡ä»¶ï¼Œç›®å½•ï¼Œ etc...</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>cache:</span></span>
<span class="line"><span>  key: cache-node-modules</span></span>
<span class="line"><span>  # åœ¨è¿™é‡Œå†™å‡ºéœ€è¦ç¼“å­˜çš„æ–‡ä»¶çš„è·¯å¾„ï¼Œåœ¨æ­¤ä¸ºnode_modules</span></span>
<span class="line"><span>  paths:</span></span>
<span class="line"><span>    - node_modules</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="retry" tabindex="-1">retry <a class="header-anchor" href="#retry" aria-label="Permalink to &quot;retry&quot;">â€‹</a></h3><p>ä¸€ä¸ªjobå¯ä»¥è¢«é‡æ–°æ‰§è¡Œçš„æœ€å¤§æ•°é‡ã€‚å¿…é¡»æ˜¯ä¸ªæ­£æ•´æ•°, 0-2, 2ä¸ºæœ€å¤§å€¼</p><ul><li>whenå¯è®¾ç½®åœ¨ç‰¹å®šå¤±è´¥åŸå› çš„æƒ…å†µä¸‹æ‰§è¡Œ</li></ul><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>job:</span></span>
<span class="line"><span>  script: rspec</span></span>
<span class="line"><span>  retry:</span></span>
<span class="line"><span>    max: 2</span></span>
<span class="line"><span>    when: runner_system_failure</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="only-except" tabindex="-1">only &amp; except <a class="header-anchor" href="#only-except" aria-label="Permalink to &quot;only &amp; except&quot;">â€‹</a></h3><ul><li><p>only: è®¾ç½®æµæ°´çº¿ä»»åŠ¡æ‰§è¡Œæ—¶æœº</p></li><li><p>except: è®¾ç½®æµæ°´çº¿ä»»åŠ¡ä¸æ‰§è¡Œæ—¶æœº</p></li></ul><p>å¯é…ç½®é€‰é¡¹ï¼ˆå¸¸ç”¨çš„å‡ ä¸ªï¼‰ï¼š</p><table><thead><tr><th>&lt;åˆ†æ”¯å&gt;</th><th>ç‰¹å®šåˆ†æ”¯changeçš„æ—¶å€™è§¦å‘</th></tr></thead><tbody><tr><td>pushes</td><td>git pushæ—¶è§¦å‘ï¼Œé€‚ç”¨äºæ‰€æœ‰åˆ†æ”¯</td></tr><tr><td>merge_requests</td><td>MRè¢«åˆ›å»ºæ—¶è§¦å‘ï¼Œé€‚ç”¨äºæ‰€æœ‰åˆ†æ”¯</td></tr><tr><td>web</td><td>æ‰‹åŠ¨åœ¨Gitlab Runner/pipelineé‡Œé¢ç‚¹å‡»run pipelineæ—¶è§¦å‘<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5a8ad4a548944afae78c11f9a4b3b68~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></td></tr></tbody></table><p>é…ç½®branchåç§°æ¥è§„å®šè§¦å‘ä»»åŠ¡çš„åˆ†æ”¯(å¦‚ä¸‹)ï¼Œ</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>myjob:</span></span>
<span class="line"><span>  only:</span></span>
<span class="line"><span>    - master</span></span>
<span class="line"><span># ä»¥ä¸Šå†™æ³•ç­‰åŒäº</span></span>
<span class="line"><span>myjob:</span></span>
<span class="line"><span>  only:</span></span>
<span class="line"><span>    variables:</span></span>
<span class="line"><span>    # $CI_COMMIT_REF_NAMEæ˜¯ä¸€ä¸ªgitlabçš„é¢„è®¾å˜é‡ï¼Œä»£è¡¨å½“å‰commitç»™å“ªä¸ªbranchä¸Šäº†</span></span>
<span class="line"><span>    - $CI_COMMIT_REF_NAME == &quot;master&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="rules-if" tabindex="-1">rules:if <a class="header-anchor" href="#rules-if" aria-label="Permalink to &quot;rules:if&quot;">â€‹</a></h3><p>æ­¤å­—æ®µå¯ä»¥åœ¨å•ä¸ªæµæ°´çº¿jobæˆ–è€…workflowå­—æ®µä¸‹è¿›è¡Œé…ç½®ã€‚</p><p><code>rules</code>å…³é”®è¯ä¸‹å¯ä»¥è¿›è¡Œifè¯­å¥é…ç½®ï¼Œå¦‚æœifæ»¡è¶³çš„è¯å¯æ‰§è¡ŒæŸäº›è‡ªå®šä¹‰é…ç½®(ä¼šåœ¨æµæ°´çº¿ä»»åŠ¡demo2ä¸­å’Œ<code>workflow</code>é…ç½®ä¸­å±•ç¤ºå¦‚ä½•ä½¿ç”¨)</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>rules:</span></span>
<span class="line"><span>  - if: $CI_COMMIT_REF_NAME =~ /feature/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>æ³¨æ„</strong>: <code>only &amp; except</code>å’Œ<code>rules:if</code>éƒ½æ˜¯ç”¨æ¥å†³å®šå•ä¸ªjobæ‰§è¡Œæ—¶æœºçš„ï¼Œåœ¨é…ç½®æ—¶åªèƒ½å­˜åœ¨ä¸€ä¸ªï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</p><h3 id="workflow" tabindex="-1">workflow <a class="header-anchor" href="#workflow" aria-label="Permalink to &quot;workflow&quot;">â€‹</a></h3><p>éœ€è¦å’Œ<code>rules</code>é…åˆç”¨æ¥æ§åˆ¶æ•´ä¸ªpipelineçš„è¡Œä¸ºï¼Œæ¯”å¦‚æ•´ä¸ªæµæ°´çº¿æ‰§è¡Œä¸å¦ã€‚æ•´ä¸ªæµæ°´çº¿æ­£å¸¸è¿è¡Œçš„å‰ææ˜¯å…¶<code>rules</code>é…ç½®ä¸­çš„<code>if</code>è¯­å¥è‡³å°‘éœ€è¦è§¦å‘ä¸€ä¸ª.</p><p>åœ¨å„ä¸ªæµæ°´çº¿ä»»åŠ¡çš„å¤–å±‚è¿›è¡Œé…ç½®</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>variables:</span></span>
<span class="line"><span>  IS_FEATURE: &quot;false&quot;</span></span>
<span class="line"><span>workflow:</span></span>
<span class="line"><span>  rules:</span></span>
<span class="line"><span>    - if: $CI_COMMIT_REF_NAME =~ /feature/</span></span>
<span class="line"><span>      variables:</span></span>
<span class="line"><span>        IS_FEATURE: &quot;true&quot;</span></span>
<span class="line"><span>    - when: always # Run the pipeline in other cases</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="when" tabindex="-1">when <a class="header-anchor" href="#when" aria-label="Permalink to &quot;when&quot;">â€‹</a></h3><p>è¿™ä¸ªå…³é”®å­—å’Œstageéœ€è¦é…åˆä½¿ç”¨ã€‚å¦‚æœä¸€ä¸ªstage failæ‰äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æœŸå¾…ä¸‹ä¸ªstageæ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>(When to run a job?)</p><ul><li><p><code>on_success</code>(default): æ‰€æœ‰ä¹‹å‰stageçš„ä»»åŠ¡éƒ½æ‰§è¡ŒæˆåŠŸäº†æ‰æ‰§è¡Œå½“å‰stageçš„ä»»åŠ¡ï¼Œæˆ–è€…ä¹‹å‰failçš„ä»»åŠ¡æœ‰é…ç½®äº†<code>allow_failure: true</code></p></li><li><p><code>on_failure</code> ï¼šåªæœ‰åœ¨ä¹‹å‰çš„æµæ°´çº¿ä»»åŠ¡æœ‰è‡³å°‘ä¸€æ¬¡çš„failä¹‹ä¸‹æ‰æ‰§è¡Œå½“å‰ä»»åŠ¡ã€‚</p></li><li><p><code>always</code>ï¼šæ— è®ºä¹‹å‰çš„stageçš„æµæ°´çº¿çš„ä»»åŠ¡çŠ¶æ€å¦‚ä½•ï¼Œå½“å‰çš„ä»»åŠ¡éƒ½ä¼šè§¦å‘ã€‚</p></li><li><p><code>never</code>ï¼šä¸è¿è¡Œå½“å‰ä»»åŠ¡</p></li><li><p><code>manual</code>ï¼šæµæ°´çº¿æ‰‹åŠ¨è§¦å‘,ç‚¹å‡»playï¼Œå¦‚ä¸‹å›¾</p></li></ul><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90db4cb0cc4a4cc5a1df5229317d30bc~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><ul><li><code>delayed</code>ï¼šå»¶è¿Ÿä¸€æ®µæ—¶é—´æ‰§è¡Œ</li></ul><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>timed rollout 10%:</span></span>
<span class="line"><span>  stage: deploy</span></span>
<span class="line"><span>  script: echo &#39;Rolling out 10% ...&#39;</span></span>
<span class="line"><span>  when: delayed</span></span>
<span class="line"><span>  # åœ¨ä¹‹å‰çš„stageæ‰§è¡Œå30minsåå†è¿è¡Œè¿™ä¸ªä»»åŠ¡</span></span>
<span class="line"><span>  # æ—¶é—´å•ä½å¯ä»¥æ˜¯secondsï¼Œminutesï¼Œday, week</span></span>
<span class="line"><span>  start_in: 30 minutes</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="tags" tabindex="-1">tags <a class="header-anchor" href="#tags" aria-label="Permalink to &quot;tags&quot;">â€‹</a></h3><p>è¿™ä¸ªæ˜¯è®¾å®šGitlab åœ¨æ‰§è¡Œè„šæœ¬æ—¶ä½¿ç”¨å“ªä¸ªrunner</p><h3 id="æ³¨æ„äº‹é¡¹" tabindex="-1">æ³¨æ„äº‹é¡¹ <a class="header-anchor" href="#æ³¨æ„äº‹é¡¹" aria-label="Permalink to &quot;æ³¨æ„äº‹é¡¹&quot;">â€‹</a></h3><p>é…ç½®æ—¶æœ‰äº›å…³é”®å­—æ¯”å¦‚<code>workflow</code>ï¼Œ<code>rules</code>ä»€ä¹ˆçš„ä¼šæ˜¾ç¤ºæŠ¥é”™ <code>XXX config conatins unknown keys.</code></p><p>è¿™ä¸ªæ˜¯å› ä¸ºå…¬å¸çš„Gitlabç‰ˆæœ¬è¾ƒæ—§ï¼ŒGitlab 12.5ä¹‹åæ‰æ”¯æŒè¿™äº›é…ç½®ã€‚</p><p><strong>e.g:</strong></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d7d5d8da67a44668a93b8261d19fb77~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p><code>only</code>ä¸­çš„<code>merge_requests</code>é…ç½®åœ¨11.6çš„ç‰ˆæœ¬åæ‰æ”¯æŒï¼Œæ‰€ä»¥æœ‰äº›å…¬å¸çš„Gitlabç‰ˆæœ¬è¿˜æ˜¯ä¸æ”¯æŒ ğŸ˜¦</p><h3 id="æ¨¡å—åŒ–å†™æ³•" tabindex="-1">æ¨¡å—åŒ–å†™æ³• <a class="header-anchor" href="#æ¨¡å—åŒ–å†™æ³•" aria-label="Permalink to &quot;æ¨¡å—åŒ–å†™æ³•&quot;">â€‹</a></h3><blockquote><p>éšç€æµæ°´çº¿ä»»åŠ¡çš„å˜å¤šï¼ŒæŠŠæ‰€æœ‰çš„ä»»åŠ¡éƒ½å†™åœ¨.gitlab-ci.ymlæ–‡ä»¶ä¸­ä¼šæ˜¾å¾—å¾ˆè‡ƒè‚¿</p><p>è§£å†³æ–¹æ³•æ˜¯æ‹†åˆ†å¤šä¸ªä»»åŠ¡åˆ°ä¸åŒçš„æ¨¡å—</p></blockquote><p>åœ¨<code>.gitlab.yml</code>æ–‡ä»¶ä¸­æŒ‰ç…§å¦‚ä¸‹å†™æ³•å³å¯å¼•å…¥ä¸åŒçš„ymlæ–‡ä»¶</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>include:</span></span>
<span class="line"><span>  - &#39;/yml/job_1_install.yml&#39;</span></span>
<span class="line"><span>  - &#39;/yml/job_2_build.yml&#39;</span></span>
<span class="line"><span>  - &#39;/yml/job_3_deploy.yml&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/236eb1e2df804ee1810634af7062838f~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><h2 id="å››ã€demoé…ç½®-è¿è¡Œç¤ºä¾‹" tabindex="-1">å››ã€Demoé…ç½®+è¿è¡Œç¤ºä¾‹ <a class="header-anchor" href="#å››ã€demoé…ç½®-è¿è¡Œç¤ºä¾‹" aria-label="Permalink to &quot;å››ã€Demoé…ç½®+è¿è¡Œç¤ºä¾‹&quot;">â€‹</a></h2><blockquote><p>ä¸‹é¢è®©æˆ‘ä»¬æ¥é…åˆè¿è¡Œç¤ºä¾‹çœ‹ä¸€çœ‹æ–‡ä»¶é…ç½®æ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„</p></blockquote><h3 id="æµæ°´çº¿demo1-åŸºç¡€ç”¨æ³•" tabindex="-1">æµæ°´çº¿Demo1(åŸºç¡€ç”¨æ³•) <a class="header-anchor" href="#æµæ°´çº¿demo1-åŸºç¡€ç”¨æ³•" aria-label="Permalink to &quot;æµæ°´çº¿Demo1(åŸºç¡€ç”¨æ³•)&quot;">â€‹</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span># .gitlab-ci.yml</span></span>
<span class="line"><span># é•œåƒä¸ºnodeçš„ç¯å¢ƒé•œåƒï¼Œå¦‚æœç”¨çš„æ˜¯åˆ«çš„ç¯å¢ƒå¯ä»¥æ›´æ”¹ä¸ºåˆ«çš„é¡¹ç›®ç¯å¢ƒçš„é•œåƒ</span></span>
<span class="line"><span>image: node:latest</span></span>
<span class="line"><span></span></span>
<span class="line"><span># è‡ªå®šä¹‰stages</span></span>
<span class="line"><span>stages:</span></span>
<span class="line"><span>  - first_stage</span></span>
<span class="line"><span>  - second_stage</span></span>
<span class="line"><span>  - third_stage</span></span>
<span class="line"><span>  - fourth_stage</span></span>
<span class="line"><span>  - fifth_stage</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span># è‡ªå®šä¹‰ä»»åŠ¡1</span></span>
<span class="line"><span>job_1_push:</span></span>
<span class="line"><span>  only:</span></span>
<span class="line"><span>    - pushes</span></span>
<span class="line"><span>  # è®¾ç½®ä½¿ç”¨fe tagsæ ‡ç­¾çš„shared runner</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - yehanli</span></span>
<span class="line"><span>  # å½“å‰ä»»åŠ¡éœ€è¦æ‰§è¡Œçš„è„šæœ¬</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - echo &#39;job1 ========= å®Œæˆ&#39;</span></span>
<span class="line"><span>  # è®¾ç½®å½“å‰ä»»åŠ¡çš„stage</span></span>
<span class="line"><span>  stage: first_stage</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span># è‡ªå®šä¹‰ä»»åŠ¡2</span></span>
<span class="line"><span>job_2_push:</span></span>
<span class="line"><span>  only:</span></span>
<span class="line"><span>    - pushes</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - yehanli</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - echo &#39;job2 ========= å®Œæˆ&#39;</span></span>
<span class="line"><span>  stage: third_stage</span></span>
<span class="line"><span># è‡ªå®šä¹‰ä»»åŠ¡3</span></span>
<span class="line"><span>job_3_push:</span></span>
<span class="line"><span>  only:</span></span>
<span class="line"><span>    - pushes</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - yehanli</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - echo &#39;job3 ========= å®Œæˆ&#39;</span></span>
<span class="line"><span>  stage: fourth_stage</span></span>
<span class="line"><span>  # è®¾ç½®å½“å‰ä»»åŠ¡ä¸ºæ‰‹åŠ¨è§¦å‘</span></span>
<span class="line"><span>  when: manual</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span># è‡ªå®šä¹‰ä»»åŠ¡4</span></span>
<span class="line"><span>job_4_push:</span></span>
<span class="line"><span>  only:</span></span>
<span class="line"><span>    - pushes</span></span>
<span class="line"><span>    - tags</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - yehanli</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - echo &#39;job4 ========= å®Œæˆ&#39;</span></span>
<span class="line"><span>  stage: fourth_stage</span></span>
<span class="line"><span>  when: always</span></span>
<span class="line"><span> </span></span>
<span class="line"><span># è‡ªå®šä¹‰ä»»åŠ¡5</span></span>
<span class="line"><span>job_5_web:</span></span>
<span class="line"><span>  only:</span></span>
<span class="line"><span>  # è®¾ç½®ä¸ºç‚¹å‡»run pipelineæ—¶è§¦å‘ï¼Œæµæ°´çº¿ä¸è‡ªåŠ¨è§¦å‘</span></span>
<span class="line"><span>    - web</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - yehanli</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - echo &#39;job5 ========= å®Œæˆ&#39;</span></span>
<span class="line"><span>  stage: fifth_stage</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f65972ca1da43ed8c58de8ce8758b2d~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>è®¾ç½®ä¸ºæ‰‹åŠ¨æ‰§è¡Œçš„job3éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æµæ°´çº¿ç‚¹å‡»è¿›è¡Œæ‰§è¡Œã€‚</p><p>å¦‚ä¸‹ä¸ºå‰4ä¸ªjobsè¿è¡Œè¾“å‡ºç»“æœ(ç‚¹å‡»ä¸Šå›¾çš„å„ä¸ªjobså³å¯çœ‹åˆ°ä¸‹å›¾è¾“å‡º)</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ebf004287d74f29978aeee195c97b6b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4f34116649be4967bee739b9e84c69b1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/30e47eab685e4e25a5c1719bd2d28256~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e081e1f01fd4fbebf10e6a7ea8092be~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>å¦‚è®¾æƒ³çš„ä¸€æ ·ï¼Œæ‰€æœ‰çš„jobséƒ½æŒ‰ç…§è®¾å®šæ‰§è¡Œäº†ä»»åŠ¡ã€‚</p><p>å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬æ²¡æœ‰å®šä¹‰second_stageçš„ä»»åŠ¡ï¼Œé‚£ä¹ˆé»˜è®¤å°±ä¼šè·³è¿‡ï¼ŒæŒ‰ç…§æˆåŠŸå¤„ç†</p><p>job5å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼è§¦å‘ï¼š</p><ol><li>pipelineç•Œé¢ç‚¹å‡»run pipeline</li></ol><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/61c54185717e404aa3fce26c74b9ef15~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><ol start="2"><li>é€‰æ‹©branchï¼Œç„¶åå†ç‚¹å‡»run pipeline</li></ol><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/044bb49201b04553876e03475555a57e~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>ä»¥ä¸‹ä¸ºè¾“å‡ºç»“æœ</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e39062d764d40ba9987f355de90a19b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/11b3695b7eef46209db50273d0c56cd4~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><h3 id="æµæ°´çº¿demo2-è¯¦ç»†ç¤ºä¾‹" tabindex="-1">æµæ°´çº¿Demo2(è¯¦ç»†ç¤ºä¾‹) <a class="header-anchor" href="#æµæ°´çº¿demo2-è¯¦ç»†ç¤ºä¾‹" aria-label="Permalink to &quot;æµæ°´çº¿Demo2(è¯¦ç»†ç¤ºä¾‹)&quot;">â€‹</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span># .gitlab-ci.yml</span></span>
<span class="line"><span>image: node:latest</span></span>
<span class="line"><span># # åœ¨è¿è¡Œæ‰€æœ‰ä»»åŠ¡ä¹‹å‰æ‰§è¡Œå¦‚ä¸‹è„šæœ¬</span></span>
<span class="line"><span>before_script:</span></span>
<span class="line"><span>  - echo &#39;====== åœ¨æ‰€æœ‰jobsä¹‹å‰è¿›è¡Œæ‰§è¡Œ =========&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>variables:</span></span>
<span class="line"><span>  IS_EXPERIENCING_MERGING: &quot;false&quot;</span></span>
<span class="line"><span>  IS_ON_MYBRANCH: &quot;false&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>workflow:</span></span>
<span class="line"><span>  rules:</span></span>
<span class="line"><span>    - if: $CI_PIPELINE_SOURCE == &quot;merge_request_event&quot;</span></span>
<span class="line"><span>      variables:</span></span>
<span class="line"><span>        IS_EXPERIENCING_MERGING: &quot;true&quot;</span></span>
<span class="line"><span>    - if: $CI_COMMIT_REF_NAME =~ /myBranch/</span></span>
<span class="line"><span>      variables:</span></span>
<span class="line"><span>        IS_ON_MYBRANCH: &quot;true&quot;</span></span>
<span class="line"><span>    - if: $CI_COMMIT_REF_NAME =~ /.*/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>cache:</span></span>
<span class="line"><span>  key: cache-node-modules</span></span>
<span class="line"><span>  # åœ¨è¿™é‡Œå†™å‡ºéœ€è¦ç¼“å­˜çš„æ–‡ä»¶çš„è·¯å¾„ï¼Œåœ¨æ­¤ä¸ºnode_modules</span></span>
<span class="line"><span>  paths:</span></span>
<span class="line"><span>    - node_modules</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span># è‡ªå®šä¹‰stages</span></span>
<span class="line"><span>stages:</span></span>
<span class="line"><span>  - first_stage</span></span>
<span class="line"><span>  - second_stage</span></span>
<span class="line"><span>  - third_stage</span></span>
<span class="line"><span>  - fourth_stage</span></span>
<span class="line"><span>  - fifth_stage</span></span>
<span class="line"><span></span></span>
<span class="line"><span>include:</span></span>
<span class="line"><span>  - &#39;/yml/job_1_install.yml&#39;</span></span>
<span class="line"><span>  - &#39;/yml/job_2_build.yml&#39;</span></span>
<span class="line"><span>  - &#39;/yml/job_3_deploy.yml&#39;</span></span>
<span class="line"><span>  - &#39;/yml/job_4_mybranch.yml&#39;</span></span>
<span class="line"><span>  - &#39;/yml/job_5_beforeMR.yml&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span># &#39;/yml/job_1_install.yml&#39;</span></span>
<span class="line"><span># install é˜¶æ®µ</span></span>
<span class="line"><span>job_1_install:</span></span>
<span class="line"><span>  only:</span></span>
<span class="line"><span>    - master</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - yehanli</span></span>
<span class="line"><span>  before_script:</span></span>
<span class="line"><span>    - echo &#39;========== job1 çš„scriptä¹‹å‰æ‰§è¡Œ ==========&#39;</span></span>
<span class="line"><span>    - npm install</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - echo &#39;job1 ========= å®Œæˆ&#39;</span></span>
<span class="line"><span>  stage: first_stage</span></span>
<span class="line"><span>  # æœ€å¤šå¤±è´¥é‡è¯•æ¬¡æ•°ä¸º3æ¬¡</span></span>
<span class="line"><span>  retry: 2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span># &#39;/yml/job_2_build.yml&#39;</span></span>
<span class="line"><span># build é˜¶æ®µ</span></span>
<span class="line"><span>job_2_build:</span></span>
<span class="line"><span>  only:</span></span>
<span class="line"><span>    - master</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - yehanli</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - npm run build</span></span>
<span class="line"><span>    - echo &#39;job2 ========= å®Œæˆ&#39;</span></span>
<span class="line"><span>  stage: second_stage</span></span>
<span class="line"><span>  retry: 2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span># &#39;/yml/job_3_deploy.yml&#39;</span></span>
<span class="line"><span># deploy é˜¶æ®µ</span></span>
<span class="line"><span>job_3_deploy:</span></span>
<span class="line"><span>  image: docker</span></span>
<span class="line"><span>  only:</span></span>
<span class="line"><span>    - master</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - yehanli</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - docker build -t reactimages .</span></span>
<span class="line"><span>    - if [ $(docker ps -aq --filter name=react-container) ]; then docker rm -f react-container; fi</span></span>
<span class="line"><span>    - docker run -d -p 8000:80 --name react-container reactimages</span></span>
<span class="line"><span>    - echo &#39;job3 ========= å®Œæˆ&#39;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>  stage: third_stage</span></span>
<span class="line"><span>  when: always</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span># &#39;/yml/job_4_mybranch.yml&#39;</span></span>
<span class="line"><span>job_4_mybranch:</span></span>
<span class="line"><span>  only:</span></span>
<span class="line"><span>    - myBranch</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - yehanli</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - echo &#39;is it on myBranch?&#39; $IS_ON_MYBRANCH</span></span>
<span class="line"><span>    - echo &#39;job4 ========= å®Œæˆ&#39;</span></span>
<span class="line"><span>  stage: fourth_stage</span></span>
<span class="line"><span>  retry: 2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span># &#39;/yml/job_5_beforeMR.yml&#39;</span></span>
<span class="line"><span>job_5_afterMR:</span></span>
<span class="line"><span>  rules:</span></span>
<span class="line"><span>    - if: &#39;$CI_COMMIT_BRANCH == &quot;master&quot;&#39; </span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - yehanli</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>      - echo &#39;Is experiencing merging?&#39; $IS_EXPERIENCING_MERGING</span></span>
<span class="line"><span>      - echo &#39;========== job_5_afterMR å®Œæˆ ===========&#39;</span></span>
<span class="line"><span>  stage: fifth_stage</span></span>
<span class="line"><span>  retry: 2</span></span>
<span class="line"><span></span></span>
<span class="line"><span>job_5_beforeMR:</span></span>
<span class="line"><span>  rules:</span></span>
<span class="line"><span>    - if: &#39;$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == &quot;master&quot;&#39;</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - yehanli</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>      - echo &#39;Is experiencing before-merge?&#39; $IS_EXPERIENCING_MERGING</span></span>
<span class="line"><span>      - echo &#39;========== job_5_beforeMR å®Œæˆ ===========&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  stage: fifth_stage</span></span>
<span class="line"><span>  retry: 2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span># pull å®˜æ–¹çš„é•œåƒï¼Œé‡å‘½åä¸ºbuilder</span></span>
<span class="line"><span>FROM node:latest as builder</span></span>
<span class="line"><span># è®¾ç½®å·¥ä½œç›®å½•ä¸º/app</span></span>
<span class="line"><span>WORKDIR /app</span></span>
<span class="line"><span># æŒ‰ç…§package.jsonæ¥å®‰è£…ä¾èµ–</span></span>
<span class="line"><span>COPY package.json ./</span></span>
<span class="line"><span>COPY package-lock.json ./</span></span>
<span class="line"><span>RUN npm install --registry=https://bnpm.byted.org</span></span>
<span class="line"><span># åŠ å…¥/appä¸‹</span></span>
<span class="line"><span>COPY . ./</span></span>
<span class="line"><span># buildä¸€ä¸‹</span></span>
<span class="line"><span>RUN npm run build</span></span>
<span class="line"><span># å°† /app/dist dir æ”¾å…¥ /nginx/html dir</span></span>
<span class="line"><span># Nginxæ˜¯ä¸€æ¬¾è½»é‡çº§çš„WebæœåŠ¡å™¨</span></span>
<span class="line"><span>FROM nginx:latest</span></span>
<span class="line"><span>COPY --from=builder /app/build /usr/share/nginx/html</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div>`,159);function d(h,g,k,f,y,v){const e=n("ArticleMetadata"),p=n("ClientOnly");return i(),r("div",null,[u,s(p,null,{default:c(()=>[s(e)]),_:1}),m])}const C=l(o,[["render",d]]);export{q as __pageData,C as default};
