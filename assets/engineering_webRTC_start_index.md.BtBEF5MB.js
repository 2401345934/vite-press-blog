import{_ as e,o as l,c as t,J as s,w as r,m as a,a as c,aa as h,E as n}from"./chunks/framework.DJCjJe2w.js";const C=JSON.parse('{"title":"WebRTC çš„åº”ç”¨åœºæ™¯","description":"","frontmatter":{"createTime":"2022/11/14","tag":"å·¥ç¨‹åŒ–,WebRTC","userName":"è£é¡¶","link":"https://github.com/wangrongding"},"headers":[],"relativePath":"engineering/webRTC/start/index.md","filePath":"engineering/webRTC/start/index.md","lastUpdated":1668392055000}'),k={name:"engineering/webRTC/start/index.md"},d=a("h1",{id:"webrtc-çš„åº”ç”¨åœºæ™¯",tabindex:"-1"},[c("WebRTC çš„åº”ç”¨åœºæ™¯ "),a("a",{class:"header-anchor",href:"#webrtc-çš„åº”ç”¨åœºæ™¯","aria-label":'Permalink to "WebRTC çš„åº”ç”¨åœºæ™¯"'},"â€‹")],-1),b=h(`<hr><p><code>WebRTC</code> (Web Real-Time Communications) æ˜¯ä¸€é¡¹<code>å®æ—¶é€šè®¯æŠ€æœ¯</code>ï¼Œå®ƒå…è®¸ç½‘ç»œåº”ç”¨æˆ–è€…ç«™ç‚¹ï¼Œåœ¨ä¸å€ŸåŠ©ä¸­é—´åª’ä»‹çš„æƒ…å†µä¸‹ï¼Œå»ºç«‹æµè§ˆå™¨ä¹‹é—´<code>ç‚¹å¯¹ç‚¹ï¼ˆPeer-to-Peerï¼‰çš„è¿æ¥</code>ï¼Œå®ç°è§†é¢‘æµå’Œï¼ˆæˆ–ï¼‰éŸ³é¢‘æµæˆ–è€…å…¶ä»–<code>ä»»æ„æ•°æ®</code>çš„ä¼ è¾“ã€‚WebRTC åŒ…å«çš„è¿™äº›æ ‡å‡†ä½¿ç”¨æˆ·åœ¨æ— éœ€å®‰è£…ä»»ä½•æ’ä»¶æˆ–è€…ç¬¬ä¸‰æ–¹çš„è½¯ä»¶çš„æƒ…å†µä¸‹ï¼Œåˆ›å»ºç‚¹å¯¹ç‚¹ï¼ˆPeer-to-Peerï¼‰çš„æ•°æ®åˆ†äº«å’Œç”µè¯ä¼šè®®æˆä¸ºå¯èƒ½ã€‚</p><h2 id="webrtc-çš„åº”ç”¨åœºæ™¯-1" tabindex="-1">WebRTC çš„åº”ç”¨åœºæ™¯ <a class="header-anchor" href="#webrtc-çš„åº”ç”¨åœºæ™¯-1" aria-label="Permalink to &quot;WebRTC çš„åº”ç”¨åœºæ™¯&quot;">â€‹</a></h2><ul><li>ç›´æ’­</li><li>æ¸¸æˆ</li><li>è§†é¢‘ä¼šè®®/åœ¨çº¿æ•™è‚²</li><li>å±å¹•å…±äº«/è¿œç¨‹æ§åˆ¶</li><li>ç­‰ç­‰ç­‰</li></ul><p>å¯ç©æ€§å¾ˆå¼ºï¼Œå¯ä»¥åšå¾ˆå¤šæœ‰è¶£çš„äº‹æƒ…ã€‚ï¼ˆå“ªæ€•æ˜¯è¢«ç©çƒ‚äº†æ¦‚å¿µâ€œå…ƒå®‡å®™â€ğŸ˜‚ï¼‰ åœ¨ç½‘é€Ÿä¸ç¡¬ä»¶è¶Šæ¥è¶Šå¥½çš„è¶‹åŠ¿ä¸‹ï¼ŒWebRTC å®ƒæœ‰æ— é™å¯èƒ½ã€‚</p><h2 id="åª’ä½“æµ" tabindex="-1">åª’ä½“æµ <a class="header-anchor" href="#åª’ä½“æµ" aria-label="Permalink to &quot;åª’ä½“æµ&quot;">â€‹</a></h2><p>è¦æƒ³äº†è§£ WebRTCï¼Œé¦–å…ˆè¦äº†è§£åª’ä½“æµï¼Œåª’ä½“æµå¯ä»¥æ˜¯æ¥è‡ªæœ¬åœ°è®¾å¤‡çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯æ¥è‡ªè¿œç¨‹è®¾å¤‡çš„ã€‚åª’ä½“æµå¯ä»¥æ˜¯å®æ—¶çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯éå®æ—¶çš„ã€‚ä¸Šè¿°çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬éƒ½éœ€è¦ä½¿ç”¨åˆ°<code>åª’ä½“æµ</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‘„åƒå¤´ï¼Œéº¦å…‹é£ï¼Œå±å¹•å…±äº«ç­‰æ–¹å¼è·å–åˆ°åª’ä½“æµï¼Œç„¶åé€šè¿‡ WebRTC æŠ€æœ¯å°†åª’ä½“æµä¼ è¾“åˆ°è¿œç«¯å®ç°å®æ—¶é€šè®¯ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7154cbc6b15046e499766463a5f09ece~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><h2 id="æ‘„åƒå¤´è·å–åª’ä½“æµåŠä¸€äº›å…¶ä»–æ“ä½œ" tabindex="-1">æ‘„åƒå¤´è·å–åª’ä½“æµåŠä¸€äº›å…¶ä»–æ“ä½œ <a class="header-anchor" href="#æ‘„åƒå¤´è·å–åª’ä½“æµåŠä¸€äº›å…¶ä»–æ“ä½œ" aria-label="Permalink to &quot;æ‘„åƒå¤´è·å–åª’ä½“æµåŠä¸€äº›å…¶ä»–æ“ä½œ&quot;">â€‹</a></h2><p>è¦å®ç° éŸ³è§†é¢‘é€šè¯ï¼Œæˆ‘ä»¬è‚¯å®šè¦å…ˆè·å–åˆ°æ‘„åƒå¤´çš„åª’ä½“æµï¼Œç„¶åé€šè¿‡ WebRTC æŠ€æœ¯å°†åª’ä½“æµä¼ è¾“åˆ°è¿œç«¯å®ç°å®æ—¶é€šè®¯ã€‚ä¸‹é¢æˆ‘ä»¬å…ˆé€šè¿‡ä¸€ä¸ªç®€å•çš„æ‹ç…§å°åº”ç”¨æ¥çœ‹ä¸€ä¸‹å¦‚ä½•é€šè¿‡æ‘„åƒå¤´è·å–åª’ä½“æµã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/508858e1fe87430085afc372da7764c1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>å…ˆè®¾ç½®å¥½ç”¨äºæ’­æ”¾åª’ä½“æµçš„ video æ ‡ç­¾ï¼Œæ·»åŠ ä¸€ä¸ª autoplay å±æ€§ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨æ‘„åƒå¤´è·å–åˆ°åª’ä½“æµåè‡ªåŠ¨æ’­æ”¾äº†ã€‚</p><div class="language-html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">video</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;localVideo&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> autoplay</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> playsinline</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> muted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">video</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒWebRTC åªèƒ½åœ¨ HTTPS åè®®æˆ–è€… localhost ä¸‹ä½¿ç”¨ï¼Œå¦‚æœæ˜¯ HTTP åè®®ï¼Œä¼šæŠ¥é”™ã€‚</strong></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/65a5f0333ef04eb1a07bd7690df13f00~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>è¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä½¿ç”¨ localhost åšç®€å•çš„æ¼”ç¤ºï¼Œåé¢é€šè¿‡<code>ä¿¡ä»¤æœåŠ¡å™¨</code>å®ç°å®æ—¶éŸ³è§†é¢‘çš„ç« èŠ‚æˆ‘ä¼šè®²åˆ°å¦‚ä½•åœ¨æœ¬åœ°ç”¨ <code>mkcert</code> åšè‡ªç­¾åè¯ä¹¦ã€‚</p><p>ok, continue ~</p><p>æˆ‘ä»¬ä¸»è¦é€šè¿‡<code>navigator.mediaDevices.getUserMedia(constraints)</code>è¿™ä¸ª api æ¥è·å–åª’ä½“æµï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ªé…ç½®å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œé…ç½®å¯¹è±¡ä¸­åŒ…å«äº†åª’ä½“æµçš„ç±»å‹ï¼Œä»¥åŠåª’ä½“æµçš„åˆ†è¾¨ç‡ç­‰ä¿¡æ¯ã€‚</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è·å–æœ¬åœ°éŸ³è§†é¢‘æµ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getLocalStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">constraints</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MediaStreamConstraints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // è·å–åª’ä½“æµ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> stream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> navigator.mediaDevices.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserMedia</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(constraints)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>å…¶ä¸­<code>constraints</code>æŒ‡å®šäº†è¯·æ±‚çš„åª’ä½“ç±»å‹å’Œç›¸å¯¹åº”çš„å‚æ•°ï¼Œç”¨äºé…ç½®è§†é¢‘æµå’ŒéŸ³é¢‘æµçš„ä¿¡æ¯ã€‚</p><p>æˆ‘å¯ä»¥çœ‹ä¸‹<code>constraints</code>å‚æ•°ä¸­å…·ä½“æ”¯æŒå“ªäº›é…ç½®é¡¹ï¼Œå¯ä»¥é€šè¿‡<code>navigator.mediaDevices.getSupportedConstraints()</code>è¿™ä¸ªæ–¹æ³•æ¥è·å–ã€‚</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;ğŸš€ğŸš€ğŸš€ / SupportedConstraints&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  navigator.mediaDevices.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSupportedConstraints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>æˆ‘ä»¬æŠŠå®ƒæ‰“å°å‡ºæ¥ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ”¯æŒçš„é…ç½®é¡¹æœ‰ï¼š<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/187ee4a65126482abda0759a8a40e4fc~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>é€šå¸¸æˆ‘ä»¬ä¸è®¾ç½®<code>constraints</code>å‚æ•°ï¼Œé‚£ä¹ˆé»˜è®¤å°±æ˜¯è·å–æ‘„åƒå¤´å’Œéº¦å…‹é£çš„åª’ä½“æµï¼Œå¦‚æœæˆ‘ä»¬åªæƒ³è¦è·å–æ‘„åƒå¤´çš„åª’ä½“æµï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™æ ·è®¾ç½®ï¼š</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">navigator.mediaDevices.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserMedia</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  audio: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  video: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>å¦‚æœæˆ‘ä»¬æƒ³è¦è·å–è§†é¢‘çš„é«˜åº¦å®½åº¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™æ ·è®¾ç½®ï¼š</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">navigator.mediaDevices.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserMedia</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  audio: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  video: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    width: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1280</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    height: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">720</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>è¯¸å¦‚æ­¤ç±»ï¼Œvideo ä¸­ä¹Ÿå¯ä»¥è®¾ç½®è®¾å¤‡ id æˆ–è€…å‰åç½®æ‘„åƒå¤´...ï¼Œ å¤§å®¶å¯ä»¥åœ¨æ”¯æŒçš„æƒ…å†µä¸‹æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥è®¾ç½®å³å¯ã€‚å…·ä½“å¯ä»¥æŸ¥çœ‹<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FMediaDevices%2FgetUserMedia" title="https://developer.mozilla.org/zh-CN/docs/Web/API/MediaDevices/getUserMedia" target="_blank" rel="noreferrer">MDN</a>ã€‚è¿™é‡Œæˆ‘ä¸åšè¿‡å¤šçš„ä»‹ç»äº†ï¼Œæˆ‘ä»¬ç»§ç»­ã€‚</p><p>è·å–é€šè¿‡æ‘„åƒå¤´è·å–åª’ä½“æµåï¼Œå°†åª’ä½“æµèµ‹å€¼ç»™ video æ ‡ç­¾çš„ srcObject å±æ€§ï¼Œè®©å…¶æ’­æ”¾ã€‚</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è·å–æœ¬åœ°éŸ³è§†é¢‘æµ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getLocalStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">constraints</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MediaStreamConstraints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // è·å–åª’ä½“æµ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> stream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> navigator.mediaDevices.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserMedia</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(constraints)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // å°†åª’ä½“æµè®¾ç½®åˆ° video æ ‡ç­¾ä¸Šæ’­æ”¾</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  playLocalStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(stream)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ’­æ”¾æœ¬åœ°è§†é¢‘æµ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> playLocalStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MediaStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> videoEl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;localVideo&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HTMLVideoElement</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  videoEl.srcObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stream</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getLocalStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  audio: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  video: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>å®ç°æ‹ç…§åŠŸèƒ½ï¼Œcanvas æ ‡ç­¾å¯ä»¥å°†åª’ä½“æµç»˜åˆ¶åˆ° canvas ä¸Šï¼Œä¹Ÿå¯ä»¥é€šè¿‡ toDataURL æ–¹æ³•å°† canvas è½¬æ¢ä¸º base64 å›¾ç‰‡ååšä¸€äº›å…¶ä»–æ“ä½œã€‚</p><p>é™„ä¸Šä¸€ä¸ª ğŸ‘‰ <a href="https://link.juejin.cn/?target=https%3A%2F%2Ffrontend-park.vercel.app%2Faudio-and-video%2FwebRTC%2Ftake-photos" title="https://frontend-park.vercel.app/audio-and-video/webRTC/take-photos" target="_blank" rel="noreferrer">ä½“éªŒåœ°å€</a></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87ce1c50fce64c75aacb220014d3d52e~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">video</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;localVideo&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> autoplay</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> playsinline</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> muted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">video</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> v-for</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;(item,index) in imgList.length&quot;</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> :key=&quot;index&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;item&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">img</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> :src=&quot;item&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> alt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>æˆ‘ä»¬é€šè¿‡è·å–å·²ç»åœ¨æ’­æ”¾åª’ä½“æµçš„ video æ ‡ç­¾ï¼Œç„¶åå°†å…¶ç»˜åˆ¶åˆ° canvas ä¸Šï¼Œå†é€šè¿‡ toDataURL æ–¹æ³•å°† canvas è½¬æ¢ä¸º base64 å›¾ç‰‡ã€‚</p><p>è¿™é‡Œä½ å¯ä»¥åŠ ä¸€äº›æ»¤é•œæˆ–è€…åŠ ä¸€äº›ç¾é¢œåŠŸèƒ½æˆ–æ˜¯å…¶ä»–çš„æ“ä½œï¼Œæœ€ç»ˆç”Ÿæˆçš„ imgUrl ç»™åˆ° img æ ‡ç­¾è®©å…¶å±•ç¤ºå°±è¡Œäº†ã€‚</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ‹ç…§</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> takePhoto</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> videoEl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;localVideo&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HTMLVideoElement</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> canvas</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;canvas&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  canvas.width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> videoEl.videoWidth</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  canvas.height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> videoEl.videoHeight</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ctx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> canvas.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2d&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drawImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(videoEl, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, canvas.width, canvas.height)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  imgList.value.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(canvas.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toDataURL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;image/png&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ğŸš€ğŸš€ğŸš€ / imgList&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, imgList)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // æ·»åŠ æ»¤é•œ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> filterList</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;blur(5px)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ¨¡ç³Š</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;brightness(0.5)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// äº®åº¦</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;contrast(200%)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¯¹æ¯”åº¦</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;grayscale(100%)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç°åº¦</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;hue-rotate(90deg)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è‰²ç›¸æ—‹è½¬</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;invert(100%)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åè‰²</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;opacity(90%)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é€æ˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;saturate(200%)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é¥±å’Œåº¦</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;saturate(20%)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é¥±å’Œåº¦</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;sepia(100%)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¤è‰²</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;drop-shadow(4px 4px 8px blue)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é˜´å½±</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> filterList.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ctx.filter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> filterList[i]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drawImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(videoEl, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, canvas.width, canvas.height)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    imgList.value.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(canvas.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toDataURL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;image/png&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>æ‹æ‘„çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ‡æ¢æ‘„åƒå¤´ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨ <code>navigator.mediaDevices.enumerateDevices</code> æ–¹æ³•ï¼Œè·å–åˆ°æ‰€æœ‰çš„è®¾å¤‡ï¼Œç„¶åç­›é€‰å‡º videoinput ç±»å‹çš„è®¾å¤‡ï¼Œæœ€åé€šè¿‡ä¸åŒçš„è®¾å¤‡ id æ¥å®ç°åˆ‡æ¢æ‘„åƒå¤´ã€‚</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è·å–æ‰€æœ‰è§†é¢‘è¾“å…¥è®¾å¤‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getDevices</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> devices</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> navigator.mediaDevices.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enumerateDevices</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ğŸš€ğŸš€ğŸš€ / devices&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, devices)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> videoDevices </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> devices.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device.kind </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;videoinput&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åˆ‡æ¢è®¾å¤‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleDeviceChange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">deviceId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  getLocalStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> stream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> navigator.mediaDevices.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserMedia</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    audio: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    video: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      deviceId: { exact: deviceId },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>è¿™é‡Œæˆ‘ä»¬æŠŠè·å–åˆ°çš„è®¾å¤‡åˆ—è¡¨ä¿¡æ¯æ‰“å°çœ‹çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯ä¸ªè®¾å¤‡éƒ½æœ‰ä¸€ä¸ª deviceIdï¼Œæˆ‘ä»¬å°±æ˜¯é€šè¿‡è¿™ä¸ª id æ¥åˆ‡æ¢è®¾å¤‡çš„ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4016821b03214f5a9f35a19767fc6fe2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè·å¾—äº†å¤šä¸ªæ‘„åƒå¤´è®¾å¤‡ï¼Œæˆ‘è¿™é‡Œæ˜¯ä¸€ä¸ªç¬”è®°æœ¬è‡ªå¸¦çš„æ‘„åƒå¤´å’Œä¸€ä¸ª OBS è™šæ‹Ÿæ‘„åƒå¤´ï¼ŒåŒ…æ‹¬æœ€è¿‘ MacOs æ›´æ–°åˆ° Ventura 13 ,IOS æ›´æ–°åˆ° 16 åçš„<code>è¿ç»­äº’é€šæ‘„åƒå¤´</code>ï¼Œéƒ½å¯ä»¥è·å–åˆ°ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨è§†é¢‘çš„æ—¶å€™ï¼Œå°±å¯ä»¥é€šè¿‡æ‹æ‘„æ›´æ¸…æ™°çš„æ‰‹æœºåç½®æ¥æ‹æ‘„äº†ã€‚</p><p>è™šæ‹Ÿæ‘„åƒå¤´æ›´æœ‰æ„æ€ï¼Œåœ¨ OBS ä¸­å¼€å¯è™šæ‹Ÿæ‘„åƒå¤´åï¼Œå¯ä»¥æ’­æ”¾ä¸€ä¸ªè§†é¢‘ï¼Œç„¶åè¿›è¡Œè§†é¢‘ä¼šè®®ï¼Œè¿™æ ·ä½ ç”šè‡³å¯ä»¥æå‰å½•åˆ¶å¥½ä¸€ä¸ªç«¯åçš„è§†é¢‘ï¼ˆç®€ç›´æ˜¯ä¸Šç½‘è¯¾å¿…å¤‡ï¼ğŸ˜…ï¼‰ï¼Œæˆ‘ä¹‹å‰è¯•è¿‡æ’­æ”¾ç‰¹æœ—æ™®çš„è§†é¢‘ï¼Œç„¶åå¾®ä¿¡è§†é¢‘ï¼Œå¯¹é¢çœ‹åˆ°çš„ç¡®å®æ˜¯ç‰¹æœ—æ™®åœ¨æ¼”è®²ï¼Œæ‰€ä»¥è¯´è¿™æ–¹é¢å¾ˆæœ‰å®‰å…¨éšæ‚£ï¼Œæ‰€ä»¥å¤§å®¶åœ¨ç½‘ä¸Šå’Œåˆ«äººè§†é¢‘çš„æ—¶å€™ï¼Œè¿˜æ˜¯éœ€è¦æ³¨æ„ä¸‹ï¼Œå¯¹æ–¹å¯èƒ½ä¸æ˜¯çœŸçš„ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/35e6428b3c76425094067f3a88f0c08c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"><br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/07e694f9c95c423c99492b8ceaaffb47~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"><br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e7dca829c42944e2a45b4b017d0070a5~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>è·‘é¢˜äº†ï¼Œæˆ‘ä»¬ç»§ç»­ã€‚ğŸ¦„ğŸ¦„ğŸ¦„</p><p>è¯´å®Œäº†åˆ‡æ¢æ‘„åƒå¤´ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä½•åœ¨æ”¯æŒåˆ‡æ¢å‰åç½®æ‘„åƒå¤´çš„è®¾å¤‡ä¸Šå¦‚ä½•åˆ‡æ¢å‰åæ‘„åƒå¤´ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®š <code>facingMode</code> æ¥å®ç°ï¼ŒfacingMode æœ‰ 4 ä¸ªå€¼ï¼Œåˆ†åˆ«æ˜¯ userã€environment å’Œ leftã€rightï¼Œåˆ†åˆ«å¯¹åº”å‰åæ‘„åƒå¤´å’Œå·¦å³æ‘„åƒå¤´ã€‚</p><p>å½“éœ€è¦å¼ºåˆ¶ä½¿ç”¨å‰ç½®æ‘„åƒå¤´æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ exact å…³é”®å­—ï¼Œä¾‹å¦‚ facingMode: { exact: &#39;user&#39; }ï¼Œå¼ºåˆ¶åˆ‡æ¢å‰åæ‘„åƒå¤´æ—¶ï¼Œå½“æ‘„åƒå¤´ä¸æ”¯æŒæ—¶ï¼Œä¼šæŠ¥ä¸€ä¸ª OverconstrainedErrorï¼»æ— æ³•æ»¡è¶³è¦æ±‚çš„é”™è¯¯ï¼½<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/779e8bb4fc7a47a29c05327ada434290~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>// åˆ‡æ¢å‰åæ‘„åƒå¤´</span></span>
<span class="line"><span>function switchCamera(val: number) {</span></span>
<span class="line"><span>  let constraints = {</span></span>
<span class="line"><span>    video: true, // å¼€å¯é»˜è®¤æ‘„åƒå¤´</span></span>
<span class="line"><span>    audio: true,</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  constraints.video = {</span></span>
<span class="line"><span>    // å¼ºåˆ¶åˆ‡æ¢å‰åæ‘„åƒå¤´æ—¶ï¼Œå½“æ‘„åƒå¤´ä¸æ”¯æŒæ—¶ï¼Œä¼šæŠ¥ä¸€ä¸ªOverconstrainedErrorï¼»æ— æ³•æ»¡è¶³è¦æ±‚çš„é”™è¯¯ï¼½</span></span>
<span class="line"><span>    facingMode: { exact: val === 1 ? &#39;user&#39; : &#39;environment&#39; },</span></span>
<span class="line"><span>    // ä¹Ÿå¯ä»¥è¿™æ ·å½“å‰åæ‘„åƒå¤´ä¸æ”¯æŒåˆ‡æ¢æ—¶ï¼Œä¼šç»§ç»­ä½¿ç”¨å½“å‰æ‘„åƒå¤´ï¼Œå¥½å¤„æ˜¯ä¸ä¼šæŠ¥é”™</span></span>
<span class="line"><span>    // facingMode: val === 1 ? &#39;user&#39; : &#39;environment&#39;,</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  navigator.mediaDevices</span></span>
<span class="line"><span>    .getUserMedia(constraints)</span></span>
<span class="line"><span>    .then((stream) =&gt; {</span></span>
<span class="line"><span>      ElMessage.success(&#39;åˆ‡æ¢æˆåŠŸ&#39;)</span></span>
<span class="line"><span>      playLocalStream(stream)</span></span>
<span class="line"><span>    })</span></span>
<span class="line"><span>    .catch((err) =&gt; {</span></span>
<span class="line"><span>      ElMessage.error(&#39;ä½ çš„è®¾å¤‡ä¸æ”¯æŒåˆ‡æ¢å‰åæ‘„åƒå¤´&#39;)</span></span>
<span class="line"><span>    })</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>switchCamera(1) // åˆ‡æ¢å‰ç½®æ‘„åƒå¤´</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f70b6a6b5be4faaa84f14442603faa5~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>é€šè¿‡è¿™ä¸ªç®€å•çš„æ‹ç…§å°åº”ç”¨ï¼Œç›¸ä¿¡æˆ‘ä»¬å·²ç»çŸ¥é“äº†é€šè¿‡æ‘„åƒå¤´è·å–åª’ä½“æµçš„å¤§æ¦‚æµç¨‹ä»¥åŠä¸€äº›å¸¸ç”¨çš„ API äº†ã€‚</p><p>ok, continue ~</p><h2 id="é€šè¿‡å±å¹•å…±äº«è·å–è·å–åª’ä½“æµ-å®ç°å½•åˆ¶ç­‰æ“ä½œ" tabindex="-1">é€šè¿‡å±å¹•å…±äº«è·å–è·å–åª’ä½“æµï¼Œå®ç°å½•åˆ¶ç­‰æ“ä½œ <a class="header-anchor" href="#é€šè¿‡å±å¹•å…±äº«è·å–è·å–åª’ä½“æµ-å®ç°å½•åˆ¶ç­‰æ“ä½œ" aria-label="Permalink to &quot;é€šè¿‡å±å¹•å…±äº«è·å–è·å–åª’ä½“æµï¼Œå®ç°å½•åˆ¶ç­‰æ“ä½œ&quot;">â€‹</a></h2><p>åœ¨è§†é¢‘ä¼šè®®ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨åˆ°å±å¹•å…±äº«ï¼Œå·²ç»æˆ‘ä»¬ç»å¸¸ä¼šæœ‰å½•åˆ¶å±å¹•ç­‰éœ€æ±‚ï¼Œå¸‚é¢ä¸Šè¿˜æœ‰é‚£ä¹ˆå¤šéœ€è¦ä»˜è´¹çš„è½¯ä»¶ï¼Œæˆ‘ä»¬é€šè¿‡ WebRTC é…åˆä¸€äº›ç›¸å…³ api è‡ªå·±å®ç°ä¸€ä¸ªä¸æ˜¯æ›´å¥½å—ï¼ŸğŸ¤”ğŸ¤”ğŸ¤” æ—¢çœé’±åˆå­¦åˆ°äº†çŸ¥è¯†ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•é€šè¿‡å±å¹•å…±äº«è·å–åª’ä½“æµå¹¶å®ç°å½•åˆ¶å‘¢ï¼Ÿä¸‹é¢é€šè¿‡ä¸€ä¸ªå° demo æ¥ç®€å•å®ç°ä¸€ä¸‹ã€‚</p><p>åœ¨ WebRTC ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>getDisplayMedia</code> æ¥è·å–å±å¹•å…±äº«çš„åª’ä½“æµï¼Œè¿™ä¸ª API ä¸ <code>getUserMedia</code> ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒåªèƒ½è·å–å±å¹•å…±äº«çš„åª’ä½“æµã€‚</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è·å–å±å¹•å…±äº«çš„åª’ä½“æµ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> shareScreen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> localStream </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> navigator.mediaDevices.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDisplayMedia</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    audio: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    video: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // æ’­æ”¾æœ¬åœ°è§†é¢‘æµ</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  playStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(localStream)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åœ¨è§†é¢‘æ ‡ç­¾ä¸­æ’­æ”¾è§†é¢‘æµ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> playStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MediaStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> video</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">querySelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;#localVideo&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HTMLVideoElement</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  video.srcObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stream</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>æ‰§è¡Œ <code>shareScreen</code> å‡½æ•°åï¼Œä¼šå¼¹å‡ºä¸€ä¸ªæƒé™è¯¢é—®æ¡†ï¼Œè¯¢é—®æ˜¯å¦å…è®¸è·å–å±å¹•å…±äº«çš„åª’ä½“æµã€‚</p><p>ç„¶åä½ å°±å¯ä»¥åˆ†äº«ä½ çš„æ•´ä¸ªå±å¹•ï¼Œå¦‚æœä½ åˆå¤šä¸ªå±å¹•çš„è¯ï¼Œä½ å¯ä»¥é€‰æ‹©å…¶ä¸­ä¸€ä¸ªè¿›è¡Œåˆ†äº«<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6cdd2153dabd4e88a802ea34d026cc70~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>ç„¶åä½ ä¹Ÿå¯ä»¥é€‰æ‹©åªåˆ†äº«ä½ å±å¹•ä¸Šçš„æŸä¸ªåº”ç”¨çš„çª—å£ï¼Œä¸ç”¨æ‹…å¿ƒä½ ä¸€è¾¹å¹²å˜›å¹²å˜›ä¸€è¾¹å½•åˆ¶å±å¹•ï¼Œå®ƒåªä¼šæ•æ‰ä½ é€‰æ‹©çš„åº”ç”¨çª—å£çš„å†…å®¹ã€‚éå¸¸ niceã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cbe6fa6e96b94a888266cf46ac39cee7~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>ä½ ç”šè‡³å¯ä»¥åœ¨ä½ æµè§ˆå™¨æ‰“å¼€çš„å„ç§é¡µé¢ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªä½ æƒ³è¦åˆ†äº«çš„ç½‘é¡µï¼Œå½“ä½ é¡µé¢å„ç§åˆ‡æ¢æ—¶å€™ï¼Œä½ çš„å±å¹•å…±äº«ä¹Ÿåªä¼šæ˜¾ç¤ºä½ é€‰æ‹©çš„ç½‘é¡µçš„å†…å®¹ã€‚</p><p>å…±äº«å‰ä½ å¯ä»¥éšä¾¿é€‰ä¸€ä¸ªè¿›è¡Œé¢„è§ˆï¼Œç„¶åå¯ä»¥é€‰æ‹©æ˜¯å¦åˆ†äº«çš„æ—¶å€™åŒ…å«é¡µé¢ä¸­çš„éŸ³é¢‘ï¼Œè¿™æ ·ä½ è·å–çš„åª’ä½“æµå°±ä¼šåŒ…å«éŸ³é¢‘è½¨é“äº†ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d94b6755607462a9e5b88ed6c818fdc~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>è¿™é‡Œæˆ‘æ‰“å¼€è‡ªå·± github çš„ç½‘é¡µï¼Œç„¶åç‚¹å‡»å±å¹•å…±äº«ï¼Œå¯ä»¥çœ‹åˆ°å…±äº«çš„åªæœ‰è‡ªå·±çš„ github é¡µé¢äº†ã€‚ä¸ç”¨æ‹…å¿ƒä¼šæœ‰ä»€ä¹ˆå¥‡æ€ªçš„ä¸œè¥¿ä¹±å…¥è¿›æ¥ï¼Œéå¸¸é€‚åˆè§†é¢‘ä¼šè®®æˆ–è€…åœ¨çº¿æ•™è‚²ç­‰åœºæ™¯ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67221d90ba214be899bbf382e9410e76~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>è¯´å®Œè·å–å±å¹•åª’ä½“æµï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•é€šè¿‡åª’ä½“æµè¿›è¡Œå½•åˆ¶ã€‚</p><p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.iana.org%2Fassignments%2Fmedia-types%2Fmedia-types.xhtml" title="https://www.iana.org/assignments/media-types/media-types.xhtml" target="_blank" rel="noreferrer">å®Œæ•´çš„ MIME ç±»å‹åˆ—è¡¨</a></p><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>MediaRecorder</code> æ¥è¿›è¡Œå½•åˆ¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨äºå½•åˆ¶åª’ä½“æµçš„ APIï¼Œå®ƒå¯ä»¥å°†åª’ä½“æµä¸­çš„æ•°æ®è¿›è¡Œå½•åˆ¶ï¼Œç„¶åå°†å½•åˆ¶çš„æ•°æ®ä¿å­˜æˆä¸€ä¸ªæ–‡ä»¶ã€‚</p><p>ç”±äº <code>MediaRecorder</code> api çš„å¯¹ mimeType å‚æ•°çš„æ”¯æŒæ˜¯æœ‰é™çš„ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡ <code>MediaRecorder.isTypeSupported</code> æ¥åˆ¤æ–­å½“å‰æµè§ˆå™¨æ˜¯å¦æ”¯æŒæˆ‘ä»¬éœ€è¦çš„ mimeTypeã€‚</p><p>chrome ä¸­ <code>MediaRecorder</code> æ”¯æŒçš„ <code>mimeType</code> å¦‚ä¸‹ï¼š</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;video/webm&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;video/webm;codecs=vp8&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;video/webm;codecs=vp9&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;video/webm;codecs=h264&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;video/x-matroska;codecs=avc1&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c5aeee0c5c5d4b2da70b56b51f900c14~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>ä¸ºäº†éªŒè¯ä¸Šè¿°çš„å†…å®¹ï¼Œè¿™é‡Œæˆ‘æŠŠä¸€äº›å¸¸ç”¨çš„ mimeType åˆ—å‡ºæ¥ï¼Œæ‹¼è£…åé€šè¿‡ <code>MediaRecorder.isTypeSupported</code> æ¥åˆ¤æ–­æ˜¯å¦æ”¯æŒï¼Œæœ€åæ”¾åˆ°ä¸‹æ‹‰æ¡†ä¸­ä¾›ç”¨æˆ·æ ¹æ®è‡ªå·±çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„ mimeTypeã€‚</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>// è·å–æ”¯æŒçš„åª’ä½“ç±»å‹</span></span>
<span class="line"><span>function getSupportedMimeTypes() {</span></span>
<span class="line"><span>  const media = &#39;video&#39;</span></span>
<span class="line"><span>  // å¸¸ç”¨çš„è§†é¢‘æ ¼å¼</span></span>
<span class="line"><span>  const types = [</span></span>
<span class="line"><span>    &#39;webm&#39;,</span></span>
<span class="line"><span>    &#39;mp4&#39;,</span></span>
<span class="line"><span>    &#39;ogg&#39;,</span></span>
<span class="line"><span>    &#39;mov&#39;,</span></span>
<span class="line"><span>    &#39;avi&#39;,</span></span>
<span class="line"><span>    &#39;wmv&#39;,</span></span>
<span class="line"><span>    &#39;flv&#39;,</span></span>
<span class="line"><span>    &#39;mkv&#39;,</span></span>
<span class="line"><span>    &#39;ts&#39;,</span></span>
<span class="line"><span>    &#39;x-matroska&#39;,</span></span>
<span class="line"><span>  ]</span></span>
<span class="line"><span>  // å¸¸ç”¨çš„è§†é¢‘ç¼–ç </span></span>
<span class="line"><span>  const codecs = [&#39;vp9&#39;, &#39;vp9.0&#39;, &#39;vp8&#39;, &#39;vp8.0&#39;, &#39;avc1&#39;, &#39;av1&#39;, &#39;h265&#39;, &#39;h264&#39;]</span></span>
<span class="line"><span>  // æ”¯æŒçš„åª’ä½“ç±»å‹</span></span>
<span class="line"><span>  const supported: string[] = []</span></span>
<span class="line"><span>  const isSupported = MediaRecorder.isTypeSupported</span></span>
<span class="line"><span>  // éå†åˆ¤æ–­æ‰€æœ‰çš„åª’ä½“ç±»å‹</span></span>
<span class="line"><span>  types.forEach((type: string) =&gt; {</span></span>
<span class="line"><span>    const mimeType = \`\${media}/\${type}\`</span></span>
<span class="line"><span>    codecs.forEach((codec: string) =&gt;</span></span>
<span class="line"><span>      [</span></span>
<span class="line"><span>        \`\${mimeType};codecs=\${codec}\`,</span></span>
<span class="line"><span>        \`\${mimeType};codecs=\${codec.toUpperCase()}\`,</span></span>
<span class="line"><span>      ].forEach((variation) =&gt; {</span></span>
<span class="line"><span>        if (isSupported(variation)) supported.push(variation)</span></span>
<span class="line"><span>      }),</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    if (isSupported(mimeType)) supported.push(mimeType)</span></span>
<span class="line"><span>  })</span></span>
<span class="line"><span>  return supported</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>console.log(getSupportedMimeTypes())</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>å¯ä»¥çœ‹åˆ°è¿™ä¹ˆå¤šæ’åˆ—ç»„åˆåï¼Œç­›é€‰å‡ºçš„æ”¯æŒçš„ mimeType ä¹Ÿå°±åªæœ‰<code>&quot;video/webm&quot;</code>å’Œ <code>&quot;video/x-matroska&quot;</code> ä¸¤ç§ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99a2702007dc4901bfa7c7539ffb8253~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>ä¹Ÿå¯ä»¥é€šè¿‡è¿™ä¸ªç½‘å€<a href="https://link.juejin.cn/?target=https%3A%2F%2Fcconcolato.github.io%2Fmedia-mime-support%2F" title="https://cconcolato.github.io/media-mime-support/" target="_blank" rel="noreferrer">ğŸ‘‰ğŸ»media-mime-support</a> æ¥æŸ¥çœ‹å½“å‰æµè§ˆå™¨æ‰€æ”¯æŒçš„ mimeType çš„æƒ…å†µã€‚</p><p>ç›®å‰æœ€å¸¸ç”¨çš„ä¸€èˆ¬éƒ½æ˜¯ <code>video/mp4</code>ã€‚ æˆªæ­¢åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæœ€ä½³çš„ 8 ç§è§†é¢‘æ ¼å¼ä¸ºï¼š<code>mp4</code> ,<code>webm</code> ,<code>mov</code> ,<code>avi</code> ,<code>mkv</code> ,<code>wmv</code> ,<code>avchd</code> ,<code>flv</code>ã€‚è€Œ webm æ˜¯ Google ä¸“é—¨ä¸º web ç«¯æ¨å‡ºçš„ä¸€ç§è§†é¢‘æ ¼å¼ã€‚100% å¼€æºï¼Œä¸” 100%å…¼å®¹ Google Chrome æµè§ˆå™¨å’Œ Android è®¾å¤‡ã€‚å¦‚æœä½ æ²¡æœ‰å¼ºçƒˆçš„éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ webm æ ¼å¼ã€‚</p><p>è¯´äº†è¿™ä¹ˆå¤šï¼Œä¸æ”¯æŒå°±ä¸èƒ½å½•åˆ¶æˆ mp4 äº†ï¼ŸğŸ¥²<br> è‚¯å®šä¸æ˜¯å•Š ğŸ˜‚</p><p>éƒ½æ‹¿åˆ° blob äº†ï¼Œå¯ä»¥é€šè¿‡ <code>ffmpeg.js</code> æ¥å°† webm æ ¼å¼è½¬æ¢æˆ mp4 æ ¼å¼ï¼Œä½†æ˜¯ <code>ffmpeg.js</code> çš„ä½“ç§¯æ¯”è¾ƒå¤§ï¼Œå¤ªé‡äº†ã€‚è¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡ä¸€ç§ hack çš„æ–¹å¼æ¥å®ç°ï¼Œä½†æ˜¯ä¸é è°±ï¼Œè¿™ç§æ–¹å¼å¯¼å‡ºçš„ mp4 æ–‡ä»¶éƒ¨åˆ†è½¯ä»¶å¯èƒ½ä¼šè¯†åˆ«ä¸äº†ï¼Œæ±‚ç¨³çš„è¯æœ€å¥½è¿˜æ˜¯æ¨èä½¿ç”¨æˆ‘ä»¬æµè§ˆå™¨ç¯å¢ƒåˆ—å‡ºçš„æ”¯æŒçš„ mimeTypeï¼Œæˆ–è€…ç”¨å·¥å…·è½¬ä¸€ä¸‹)</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>// å½•åˆ¶åª’ä½“æµ</span></span>
<span class="line"><span>function startRecord() {</span></span>
<span class="line"><span>  const kbps = 1024</span></span>
<span class="line"><span>  const Mbps = kbps * kbps</span></span>
<span class="line"><span>  const options = {</span></span>
<span class="line"><span>    audioBitsPerSecond: 128000,</span></span>
<span class="line"><span>    videoBitsPerSecond: 2500000,</span></span>
<span class="line"><span>    mimeType: &#39;video/webm; codecs=&quot;vp8,opus&quot;&#39;,</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  const mediaRecorder = new MediaRecorder(localStream, options)</span></span>
<span class="line"><span>  mediaRecorder.start()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  mediaRecorder.ondataavailable = (e) =&gt; {</span></span>
<span class="line"><span>    // å°†å½•åˆ¶çš„æ•°æ®åˆå¹¶æˆä¸€ä¸ª Blob å¯¹è±¡</span></span>
<span class="line"><span>    // const blob = new Blob([e.data], { type: e.data.type })</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ğŸŒ¸é‡ç‚¹æ˜¯è¿™ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬ä¸è¦æŠŠè·å–åˆ°çš„ e.data.typeè®¾ç½®æˆ blob çš„ typeï¼Œè€Œæ˜¯ç›´æ¥æ”¹æˆ mp4</span></span>
<span class="line"><span>    const blob = new Blob([e.data], { type: &#39;video/mp4&#39; })</span></span>
<span class="line"><span>    downloadBlob(blob)</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  mediaRecorder.onstop = (e: Event) =&gt; {</span></span>
<span class="line"><span>    // åœæ­¢å½•åˆ¶</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¸‹è½½ Blob</span></span>
<span class="line"><span>function downloadBlob(blob: Blob) {</span></span>
<span class="line"><span>  // å°† Blob å¯¹è±¡è½¬æ¢æˆä¸€ä¸ª URL åœ°å€</span></span>
<span class="line"><span>  const url = URL.createObjectURL(blob)</span></span>
<span class="line"><span>  const a = document.createElement(&#39;a&#39;)</span></span>
<span class="line"><span>  // è®¾ç½® a æ ‡ç­¾çš„ href å±æ€§ä¸ºåˆšåˆšç”Ÿæˆçš„ URL åœ°å€</span></span>
<span class="line"><span>  a.href = url</span></span>
<span class="line"><span>  // è®¾ç½® a æ ‡ç­¾çš„ download å±æ€§ä¸ºæ–‡ä»¶å</span></span>
<span class="line"><span>  a.download = \`\${new Date().getTime()}.\${blob.type.split(&#39;/&#39;)[1]}\`</span></span>
<span class="line"><span>  // æ¨¡æ‹Ÿç‚¹å‡» a æ ‡ç­¾</span></span>
<span class="line"><span>  a.click()</span></span>
<span class="line"><span>  // é‡Šæ”¾ URL åœ°å€</span></span>
<span class="line"><span>  URL.revokeObjectURL(url)</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥æ„‰å¿«çš„å½•åˆ¶è§†é¢‘äº†ã€‚å½“ç„¶è¿™é‡Œåªæ˜¯ç”¨åˆ†äº«å±å¹•çš„æ–¹å¼æ¥å½•åˆ¶è§†é¢‘ï¼Œå¦‚æœä½ æƒ³è¦å½•åˆ¶æ‘„åƒå¤´çš„è§†é¢‘ï¼Œä¹Ÿæ˜¯ä¸€æ ·ï¼Œæ‹¿åˆ°åª’ä½“æµåï¼Œå°±å¯ä»¥ç›´æ¥å½•åˆ¶äº†ã€‚</p><p><a href="https://link.juejin.cn/?target=https%3A%2F%2Ffrontend-park.vercel.app%2Faudio-and-video%2FwebRTC%2Faudio-and-video%2FwebRTC%2Frecord" title="https://frontend-park.vercel.app/audio-and-video/webRTC/audio-and-video/webRTC/record" target="_blank" rel="noreferrer">ğŸ‘‰ çº¿ä¸Šä½“éªŒåœ°å€ï¼š</a></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12fae373d86b4e9095d5c815a96eda46~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>å½“ç„¶ï¼Œæ—¢ç„¶éƒ½æ‹¿åˆ°äº†åª’ä½“æµï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†åª’ä½“æµä¸­çš„è§†é¢‘è½¨é“å½•åˆ¶æˆ gif å›¾ç‰‡ï¼Œè¿™æ ·åœ¨ä¸€äº›åœºæ™¯ä¸‹åˆ†äº«èµ·æ¥ä¹Ÿä¼šæ›´åŠ æ–¹ä¾¿ã€‚</p><p>ç”±äº <code>MediaRecorder</code> api ä¸æ”¯æŒå°† mimeType è®¾ç½®æˆ image/gif ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“<code>MediaStreamRecorder</code>æ¥å®ç°ã€‚å®ƒçš„ç”¨æ³•å’Œ <code>MediaRecorder</code> åŸºæœ¬ä¸€è‡´ã€‚æˆ‘å°±ä¸å†èµ˜è¿°äº†ã€‚</p><p>æœ€åæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œä¹Ÿæ˜¯æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­é‡åˆ°çš„é—®é¢˜ã€‚æˆªæ­¢åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåœ¨ä½¿ç”¨ <code>MediaRecorder</code> å½•åˆ¶è§†é¢‘çš„æ—¶å€™ï¼Œå¦‚æœä½ çš„ç³»ç»Ÿæ˜¯ Windows æˆ–è€… Chrome OSï¼Œé‚£ä¹ˆå½•åˆ¶çš„è§†é¢‘æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯åœ¨ Mac å’Œ Linux ä¸Šï¼Œå½•åˆ¶æ‘„åƒå¤´å’Œåˆ†äº«å±å¹•æ—¶ï¼Œé€‰æ‹©ç½‘é¡µçš„åˆ†äº«æ–¹å¼ï¼Œæ‰€æ‹¿è·å¾—çš„åª’ä½“æµæ˜¯å¯ä»¥æ‹¿åˆ°è§†é¢‘è½¨é“å’ŒéŸ³é¢‘è½¨é“çš„ï¼Œä½†æ˜¯å½•åˆ¶æ•´ä¸ªå±å¹•æ—¶ï¼Œç”±äºç³»ç»Ÿçš„é™åˆ¶ï¼Œåªèƒ½æ‹¿åˆ°è§†é¢‘çš„è½¨é“ã€‚å¥½åœ¨ä¸€èˆ¬å½•å±éƒ½ä¸ä¼šæœ‰å¸¦éŸ³é¢‘çš„éœ€æ±‚ï¼ŒæœŸå¾…åé¢èƒ½å¤Ÿæ”¯æŒã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/245eb5e34b184764bde713c699a0e41c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><h2 id="å®ç°è§†é¢‘çš„è™šæ‹ŸèƒŒæ™¯" tabindex="-1">å®ç°è§†é¢‘çš„è™šæ‹ŸèƒŒæ™¯ <a class="header-anchor" href="#å®ç°è§†é¢‘çš„è™šæ‹ŸèƒŒæ™¯" aria-label="Permalink to &quot;å®ç°è§†é¢‘çš„è™šæ‹ŸèƒŒæ™¯&quot;">â€‹</a></h2><p>åœ¨è§†é¢‘ä¼šè®®ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šçœ‹åˆ°ä¸€äº›äººåœ¨è§†é¢‘ä¸­çš„èƒŒæ™¯æ˜¯è™šæ‹Ÿçš„ï¼Œè¿™æ ·å¯ä»¥è®©æˆ‘ä»¬æ›´ä¸“æ³¨äºå¯¹æ–¹çš„è¡¨æƒ…å’Œè¯­è¨€ï¼Œè€Œä¸ä¼šè¢«èƒŒæ™¯ä¸­çš„ä¸€äº›å¹²æ‰°å› ç´ æ‰€åˆ†æ•£æ³¨æ„åŠ›ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•å®ç°è¿™æ ·çš„æ•ˆæœå‘¢ï¼Ÿ</p><p>ä¸‹é¢æˆ‘ä»¬å…ˆé€šè¿‡ä¸€ä¸ªç®€å•çš„ demo æ¥çœ‹çœ‹æ•ˆæœã€‚</p><p><a href="https://link.juejin.cn/?target=https%3A%2F%2Ffrontend-park.vercel.app%2Faudio-and-video%2FwebRTC%2Fbackground-process" title="https://frontend-park.vercel.app/audio-and-video/webRTC/background-process" target="_blank" rel="noreferrer">ğŸ‘‰ çº¿ä¸Šä½“éªŒåœ°å€</a></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb0c083b16fa42e2822fdfaefc1727d4~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>ä¸»è¦åŸç†æ˜¯é€šè¿‡ <code>canvas</code> å°†è§†é¢‘ä¸­çš„æ¯ä¸€å¸§ç”»åˆ°ç”»å¸ƒä¸Šï¼Œç„¶åå°†ç”»å¸ƒä¸­çš„åƒç´ é€ä¸ªä¸è®¾å®šçš„èƒŒæ™¯è‰²ï¼ˆé»˜è®¤æ˜¯ç»¿è‰²ï¼Œä½ å¯ä»¥æ›´æ¢ä¸ºä»»æ„ç¬¦åˆä½ èƒŒæ™¯çš„é¢œè‰²ï¼‰è¿›è¡Œè®¡ç®—ï¼Œæ¯”è¾ƒåçš„å·®å€¼è¾¾åˆ°è®¾å®šçš„é˜ˆå€¼æ—¶ï¼Œå¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œå°†å…¶æ›´æ¢ä¸ºé¢„å…ˆå‡†å¤‡å¥½çš„èƒŒæ™¯å›¾çš„å›¾åƒæ•°æ®ï¼Œæœ€åå°†å¤„ç†åçš„å›¾åƒæ•°æ®å†ç”»åˆ°è™šæ‹ŸèƒŒæ™¯ç”»å¸ƒä¸Šï¼Œé€šè¿‡è™šæ‹ŸèƒŒæ™¯ç”»å¸ƒæ‹¿åˆ°åª’ä½“æµåç»™åˆ° video æ ‡ç­¾æ’­æ”¾ï¼Œ è¿™æ ·å°±å®ç°äº†è§†é¢‘çš„è™šæ‹ŸèƒŒæ™¯æ•ˆæœã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“çš„å®ç°ã€‚</p><p>ä¸ºä¿æŒå¤§å°ä¸€è‡´ï¼Œè¿™é‡Œæˆ‘ä»¬ç»Ÿä¸€è®¾ç½®ç”»å¸ƒå’Œè§†é¢‘çš„å®½é«˜ä¸º 480*300ã€‚</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>&lt;canvas id=&quot;backgroundImg&quot; width=&quot;480&quot; height=&quot;300&quot;&gt;&lt;/canvas&gt;</span></span>
<span class="line"><span>&lt;video id=&quot;real-video&quot; width=&quot;480&quot; height=&quot;300&quot; autoplay muted&gt;&lt;/video&gt;</span></span>
<span class="line"><span>&lt;video id=&quot;virtual-video&quot; width=&quot;480&quot; height=&quot;300&quot; autoplay muted&gt;&lt;/video&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å‡†å¤‡å¥½èƒŒæ™¯å›¾ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨äº†ä¸€å¼ å›¾ç‰‡ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è§†é¢‘ä½œä¸ºèƒŒæ™¯ã€‚</p><p>é€šè¿‡ canvas å°†èƒŒæ™¯å›¾ç”»åˆ°ç”»å¸ƒä¸Šï¼Œç„¶åé€šè¿‡ <code>getImageData</code> æ–¹æ³•æ‹¿åˆ°å›¾åƒæ•°æ®ã€‚</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>// è™šæ‹ŸèƒŒæ™¯çš„ canvasä¸­çš„å›¾ç‰‡æ•°æ®</span></span>
<span class="line"><span>let backgroundImageData: ImageData</span></span>
<span class="line"><span>// è·å–èƒŒæ™¯å›¾åƒæ•°æ®</span></span>
<span class="line"><span>function getBackgroundImageData() {</span></span>
<span class="line"><span>  const backgroundCanvas = document.querySelector(</span></span>
<span class="line"><span>    &#39;#backgroundImg&#39;,</span></span>
<span class="line"><span>  ) as HTMLCanvasElement</span></span>
<span class="line"><span>  const backgroundCtx = backgroundCanvas.getContext(&#39;2d&#39;)!</span></span>
<span class="line"><span>  const img = new Image()</span></span>
<span class="line"><span>  img.src = &#39;https://xxxx.png&#39;</span></span>
<span class="line"><span>  img.onload = () =&gt; {</span></span>
<span class="line"><span>    backgroundCtx.drawImage(</span></span>
<span class="line"><span>      img,</span></span>
<span class="line"><span>      0,</span></span>
<span class="line"><span>      0,</span></span>
<span class="line"><span>      backgroundCanvas.width,</span></span>
<span class="line"><span>      backgroundCanvas.height,</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    backgroundImageData = backgroundCtx.getImageData(</span></span>
<span class="line"><span>      0,</span></span>
<span class="line"><span>      0,</span></span>
<span class="line"><span>      backgroundCanvas.width,</span></span>
<span class="line"><span>      backgroundCanvas.height,</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>ç„¶åæˆ‘ä»¬éœ€è¦é€šè¿‡æ‘„åƒå¤´è·å–åˆ°è§†é¢‘æµï¼Œè¿˜æ˜¯ç”¨ä¹‹å‰å‡ ä¸ª demo ä¸­çš„æ–¹æ³•ã€‚</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>// è·å–æœ¬åœ°éŸ³è§†é¢‘æµ</span></span>
<span class="line"><span>async function getLocalStream(options: MediaStreamConstraints) {</span></span>
<span class="line"><span>  const stream = await navigator.mediaDevices.getUserMedia(options)</span></span>
<span class="line"><span>  return stream</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ’­æ”¾åŸå§‹è§†é¢‘æµ</span></span>
<span class="line"><span>function playRealVideo(stream: MediaStream) {</span></span>
<span class="line"><span>  realVideo = document.querySelector(&#39;#real-video&#39;) as HTMLVideoElement</span></span>
<span class="line"><span>  realVideo.srcObject = stream</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>ä¸Šè¿°æ­¥éª¤å®Œæˆåï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åˆ›å»º <code>canvas</code> æ ‡ç­¾ å…ˆå°†çœŸå®çš„è§†é¢‘æ¯éš” 40ms ä¸€æ¬¡ ç”»åˆ°ç”»å¸ƒä¸Šã€‚</p><p>è¿™æ ·çš„è¯ï¼Œç”»å¸ƒå°±ä¼šä¸æ–­çš„æ›´æ–°ï¼Œèƒ½è¾¾åˆ° 25 å¸§çš„æ•ˆæœï¼Œè¿™æ ·èƒ½ä¿è¯æˆ‘ä»¬çš„è§†é¢‘æµæ˜¯éå¸¸æµç•…çš„ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œäººçœ¼èˆ’é€‚æ”¾æ¾æ—¶å¯è§†å¸§æ•°æ˜¯æ¯ç§’ 24 å¸§ï¼Œé«˜åº¦é›†ä¸­ç²¾ç¥æ—¶ä¸è¶…è¿‡ 30 å¸§ã€‚ç”µå½±é™¢é‡Œçš„ 2D ç”µå½±ä¸€èˆ¬æ˜¯ 24 å¸§çš„ï¼Œ3D ç”µå½±ä¸€èˆ¬æ˜¯ 60 å¸§ä»¥ä¸Šã€‚</p><p>ç”»åˆ°ç”»å¸ƒåï¼Œæˆ‘ä»¬ä¹Ÿç›¸åº”çš„è¦é€šè¿‡ <code>getImageData</code> æ–¹æ³•æ‹¿åˆ°çœŸå®è§†é¢‘çš„å›¾åƒæ•°æ®ã€‚</p><p>ç„¶åæ¯ä¸€å¸§éƒ½è¦ä¸è®¾ç½®å¥½çš„èƒŒæ™¯è‰²è¿›è¡Œæ¯”è¾ƒï¼Œæ¯”è¾ƒåçš„å·®å€¼è¾¾åˆ°è®¾å®šçš„é˜ˆå€¼çš„åƒç´ ï¼Œå°±è¦æ‰£é™¤ï¼ˆæ›¿æ¢ä¸ºä¹‹å‰æ‹¿åˆ°çš„èƒŒæ™¯å›¾çš„åƒç´ ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f1d64a29c3c24d828f117d9951d6aba1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"><br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d0ab76d1315c42fca106ade3f82a3b6b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>çœ‹åˆ°è¿™é‡Œ,å¦‚æœä»¥å‰çœ‹è¿‡æˆ‘çš„æ–‡ç« ï¼Œå¤§å®¶ä¸€å®šå¾ˆçœ¼ç†Ÿï¼Œè¿™ä¸ªè®¡ç®—é¢œè‰²å·®çš„é€»è¾‘ä¸æˆ‘ä¹‹å‰å†™çš„<a href="https://juejin.cn/post/6996431901623844894" title="https://juejin.cn/post/6996431901623844894" target="_blank" rel="noreferrer">ã€Šæˆ‘ç”¨ 10000 å¼ å›¾ç‰‡åˆæˆæˆ‘ä»¬ç¾å¥½çš„ç¬é—´ã€‹</a>ç”¨æ¥åšåˆæˆå›¾çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ã€‚</p><p>é¦–å…ˆéœ€è¦æ˜ç™½çš„ä¸€ç‚¹å°±æ˜¯ï¼Œrgb çš„è‰²åŸŸæ˜¯ä¸€ä¸ª 3 ç»´çš„ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¡ç®—ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»æ¥åˆ¤æ–­ä¸¤ä¸ªé¢œè‰²çš„å·®å¼‚ã€‚è·ç¦»è¶Šå°ï¼Œé¢œè‰²å·®å¼‚è¶Šå°ã€‚</p><p>è€Œè¿™åªéœ€è¦æˆ‘ä»¬ä¸­å­¦æ—¶æœŸå­¦è¿‡çš„ æ¬§å¼è·ç¦» å…¬å¼å°±å¯ä»¥äº†ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/23ed293fcf8f44898e00d32e5373c4ae~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>æˆ‘ä»¬æŠŠå®ƒè½¬åŒ–ä¸ºé¢œè‰²å·®çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>// è®¡ç®—é¢œè‰²å·®</span></span>
<span class="line"><span>function colorDiff(color1: number[], color2: number[]) {</span></span>
<span class="line"><span>  const r = color1[0] - color2[0]</span></span>
<span class="line"><span>  const g = color1[1] - color2[1]</span></span>
<span class="line"><span>  const b = color1[2] - color2[2]</span></span>
<span class="line"><span>  return Math.sqrt(r * r + g * g + b * b)</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>ç„¶åå†å°†å¤„ç†åçš„å›¾åƒæ•°æ®ç”»åˆ°è™šæ‹Ÿè§†é¢‘çš„ç”»å¸ƒä¸Šï¼Œå†é€šè¿‡<code>captureStream</code>api å°†ç”»å¸ƒè½¬æ¢ä¸ºè§†é¢‘æµï¼Œæœ€åå°†è§†é¢‘æµèµ‹å€¼ç»™è™šæ‹Ÿè§†é¢‘çš„ <code>srcObject</code> å±æ€§ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>const WIDTH = 480 // è§†é¢‘å®½åº¦</span></span>
<span class="line"><span>const HEIGHT = 300 // è§†é¢‘é«˜åº¦</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å°†è§†é¢‘å†™åˆ° canvas ä¸­</span></span>
<span class="line"><span>function drawVideoToCanvas(realVideo: HTMLVideoElement) {</span></span>
<span class="line"><span>  realVideoCanvas = document.createElement(&#39;canvas&#39;) as HTMLCanvasElement</span></span>
<span class="line"><span>  realVideoCtx = realVideoCanvas.getContext(&#39;2d&#39;)!</span></span>
<span class="line"><span>  virtualVideoCanvas = document.createElement(&#39;canvas&#39;) as HTMLCanvasElement</span></span>
<span class="line"><span>  virtualVideoCtx = virtualVideoCanvas.getContext(&#39;2d&#39;)!</span></span>
<span class="line"><span>  realVideoCanvas.width = virtualVideoCanvas.width = WIDTH</span></span>
<span class="line"><span>  realVideoCanvas.height = virtualVideoCanvas.height = HEIGHT</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ¯éš” 100ms å°†çœŸå®çš„è§†é¢‘å†™åˆ° canvas ä¸­ï¼Œå¹¶è·å–è§†é¢‘çš„å›¾åƒæ•°æ®</span></span>
<span class="line"><span>  setInterval(() =&gt; {</span></span>
<span class="line"><span>    realVideoCtx.drawImage(</span></span>
<span class="line"><span>      realVideo,</span></span>
<span class="line"><span>      0,</span></span>
<span class="line"><span>      0,</span></span>
<span class="line"><span>      realVideoCanvas.width,</span></span>
<span class="line"><span>      realVideoCanvas.height,</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    // è·å– realVideoCanvas ä¸­çš„å›¾åƒæ•°æ®</span></span>
<span class="line"><span>    realVideoImageData = realVideoCtx.getImageData(</span></span>
<span class="line"><span>      0,</span></span>
<span class="line"><span>      0,</span></span>
<span class="line"><span>      realVideoCanvas.width,</span></span>
<span class="line"><span>      realVideoCanvas.height,</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    // å¤„ç†çœŸå®è§†é¢‘çš„å›¾åƒæ•°æ®ï¼Œå°†å…¶å†™åˆ°è™šæ‹Ÿè§†é¢‘çš„ canvas ä¸­</span></span>
<span class="line"><span>    processFrameDrawToVirtualVideo()</span></span>
<span class="line"><span>  }, 40)</span></span>
<span class="line"><span>  // ä» VirtualVideoCanvas ä¸­è·å–è§†é¢‘æµå¹¶åœ¨ virtualVideo ä¸­æ’­æ”¾</span></span>
<span class="line"><span>  getStreamFromVirtualVideoCanvas()</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä» VirtualVideoCanvas ä¸­è·å–è§†é¢‘æµå¹¶åœ¨ virtualVideo ä¸­æ’­æ”¾</span></span>
<span class="line"><span>function getStreamFromVirtualVideoCanvas() {</span></span>
<span class="line"><span>  virtualVideo = document.querySelector(&#39;#virtual-video&#39;) as HTMLVideoElement</span></span>
<span class="line"><span>  const stream = virtualVideoCanvas.captureStream(30)</span></span>
<span class="line"><span>  virtualVideo.srcObject = stream</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>é€åƒç´ è®¡ç®—ä¸è¦å¤„ç†çš„ç›®æ ‡é¢œè‰²çš„å·®å€¼ï¼Œå¦‚æœå·®å€¼å°äºå®¹å·®ï¼Œåˆ™å°†è¯¥åƒç´ è®¾ç½®ä¸ºèƒŒæ™¯å›¾ç‰‡ä¸­çš„å¯¹åº”åƒç´ </p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>// å¤„ç†çœŸå®è§†é¢‘çš„å›¾åƒæ•°æ®ï¼Œå°†å…¶å†™åˆ°è™šæ‹Ÿè§†é¢‘çš„ canvas ä¸­</span></span>
<span class="line"><span>function processFrameDrawToVirtualVideo() {</span></span>
<span class="line"><span>  // é€åƒç´ è®¡ç®—ä¸è¦å¤„ç†çš„ç›®æ ‡é¢œè‰²çš„å·®å€¼ï¼Œå¦‚æœå·®å€¼å°äºé˜ˆå€¼ï¼Œåˆ™å°†è¯¥åƒç´ è®¾ç½®ä¸ºèƒŒæ™¯å›¾ç‰‡ä¸­çš„å¯¹åº”åƒç´ </span></span>
<span class="line"><span>  for (let i = 0; i &lt; realVideoImageData.data.length; i += 4) {</span></span>
<span class="line"><span>    const r = realVideoImageData.data[i]</span></span>
<span class="line"><span>    const g = realVideoImageData.data[i + 1]</span></span>
<span class="line"><span>    const b = realVideoImageData.data[i + 2]</span></span>
<span class="line"><span>    const a = realVideoImageData.data[i + 3]</span></span>
<span class="line"><span>    const bgR = backgroundImageData.data[i]</span></span>
<span class="line"><span>    const bgG = backgroundImageData.data[i + 1]</span></span>
<span class="line"><span>    const bgB = backgroundImageData.data[i + 2]</span></span>
<span class="line"><span>    const bgA = backgroundImageData.data[i + 3]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¡ç®—ä¸èƒŒæ™¯è‰²çš„å·®å€¼</span></span>
<span class="line"><span>    const diff = colorDiff([r, g, b], backgroundColor)</span></span>
<span class="line"><span>    // å½“å·®å€¼å°äºè®¾å®šçš„é˜ˆå€¼ï¼Œåˆ™å°†è¯¥åƒç´ è®¾ç½®ä¸ºèƒŒæ™¯å›¾ç‰‡ä¸­çš„å¯¹åº”åƒç´ </span></span>
<span class="line"><span>    if (diff &lt; allowance.value) {</span></span>
<span class="line"><span>      realVideoImageData.data[i] = bgR</span></span>
<span class="line"><span>      realVideoImageData.data[i + 1] = bgG</span></span>
<span class="line"><span>      realVideoImageData.data[i + 2] = bgB</span></span>
<span class="line"><span>      realVideoImageData.data[i + 3] = bgA</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  // å°†å¤„ç†åçš„å›¾åƒæ•°æ®å†™åˆ°è™šæ‹Ÿè§†é¢‘çš„ canvas ä¸­</span></span>
<span class="line"><span>  virtualVideoCtx.putImageData(realVideoImageData, 0, 0)</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è®¡ç®—é¢œè‰²å·®å¼‚</span></span>
<span class="line"><span>function colorDiff(rgba1: number[], rgba2: number[]) {</span></span>
<span class="line"><span>  let d = 0</span></span>
<span class="line"><span>  for (let i = 0; i &lt; rgba1.length; i++) {</span></span>
<span class="line"><span>    d += (rgba1[i] - rgba2[i]) ** 2</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  return Math.sqrt(d)</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå…¶ä¸­<code>backgroundColor</code>ï¼ˆéœ€è¦æ‰£é™¤çš„èƒŒæ™¯è‰²ï¼‰å’Œ<code>allowance</code>ï¼ˆå®¹å·®å€¼ï¼‰ä¸¤ä¸ªå˜é‡æ˜¯ç”±å¤–éƒ¨æ§åˆ¶çš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨é¡µé¢ä¸Šé€šè¿‡æ»‘åŠ¨æ¡æˆ–æ˜¯å…¶ä»–çš„ç»„ä»¶æ¥åŠ¨æ€æ”¹å˜å®¹å·®ï¼Œé€šè¿‡å–è‰²å™¨æ¥åŠ¨æ€æ”¹å˜éœ€è¦æ‰£é™¤çš„èƒŒæ™¯è‰²ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d4c4a4c37dd140d689892b22cd3dba78~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><h2 id="æœ€å" tabindex="-1">æœ€å <a class="header-anchor" href="#æœ€å" aria-label="Permalink to &quot;æœ€å&quot;">â€‹</a></h2><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°ä¸€ä¸ªç®€å•çš„èƒŒæ™¯æ›¿æ¢çš„åŠŸèƒ½äº†ã€‚å½“ç„¶ï¼Œè¿™é‡Œåªæ˜¯ç®€å•çš„å®ç°äº†ä¸€ä¸ªèƒŒæ™¯æ›¿æ¢çš„åŠŸèƒ½ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æ›´å¤šçš„æŠ€æœ¯æ‰‹æ®µæ¥å®ç°æ›´åŠ å¤æ‚çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š</p><p>ç›®å‰åªæ˜¯é’ˆå¯¹çº¯è‰²çš„èƒŒæ™¯è¿›è¡Œäº†æ›¿æ¢ï¼Œå¦‚æœå¤æ‚çš„èƒŒæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å›¾åƒåˆ†å‰²çš„æ–¹å¼æ¥å®ç°èƒŒæ™¯æ›¿æ¢ï¼Œæ¯”å¦‚ï¼šTensorFlow.js ä¸­çš„ èº«ä½“åˆ†å‰²ï¼ˆBodyPixï¼‰ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f262d5322e6641f7a35ae91bd60355ef~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p><p>æˆ–è€…æ˜¯è¯´ï¼Œå¯¹äºè§†é¢‘ä¸­çš„äººè„¸ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>face-api.js</code>æ¥æ£€æµ‹äººè„¸ï¼Œå¹¶å°†äººè„¸æ›¿æ¢ä¸ºå…¶ä»–çš„å›¾ç‰‡ï¼Œä»è€Œå®ç°ä¸€ä¸ªç®€å•çš„æ¢è„¸åŠŸèƒ½ã€‚å¯¹äºè§†é¢‘ä¸­çš„äººä½“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>BodyPix</code>æ¥æ£€æµ‹äººä½“ï¼Œå¹¶å°†äººä½“æ›¿æ¢ä¸ºå…¶ä»–çš„å›¾ç‰‡ï¼Œä»è€Œå®ç°ä¸€ä¸ªç®€å•çš„æ¢è£…åŠŸèƒ½ã€‚ç­‰ç­‰...ï¼ˆåç»­æˆ‘éƒ½åœ¨è¿™ä¸ªä¸“æ ä¸­å®‰æ’~ï¼‰</p><p>å¯ä»¥è§å¾—ï¼Œç”¨ WebRTC ç›¸å…³çš„çŸ¥è¯†æ¥ç»“åˆä¸€äº›å…¶ä»–ç›¸å…³æŠ€æœ¯ï¼Œå¯ä»¥å®ç°éå¸¸å¤šçš„æœ‰è¶£çš„é¡¹ç›®ï¼Œå¯ç©æ€§éå¸¸å¼ºã€‚</p><p>è¿™ä½œä¸ºæˆ‘ä¸“æ çš„ç¬¬ä¸€ç¯‡ï¼Œä¸»è¦æ˜¯æƒ³é€šè¿‡è¿™ç¯‡æ–‡ç« æ¥ä»‹ç»ä¸€ä¸‹ WebRTC ç›¸å…³çš„çŸ¥è¯†ï¼Œä»¥åŠ WebRTC ç›¸å…³çš„ä¸€äº›åº”ç”¨åœºæ™¯ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©åˆ°å¤§å®¶ã€‚</p><p>æœ¬æ¥è¿˜æƒ³å†™ä¸‹ 1v1 è§†é¢‘èŠå¤©çš„å®ç°ï¼Œä½†æ˜¯ç”±äºæ—¶é—´å…³ç³»ï¼Œæˆ‘æŠŠå®ƒæ”¾åˆ°ç¬¬äºŒç¯‡æ¥å†™å§ï¼Œdemo æˆ‘å·²ç»æ”¾åˆ°äº† æˆ‘çš„<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fwangrongding%2Ffrontend-park" title="https://github.com/wangrongding/frontend-park" target="_blank" rel="noreferrer">å‰ç«¯å…¬å›­åˆé›†ä»“åº“</a>ä¸­ï¼Œè¿™ä¸¤å¤©æŠ½ç©ºå†™å®Œ,å¤§å®¶ä¹Ÿå¯ä»¥ follow ä¸€ä¸‹æˆ‘çš„ Githubï¼Œè°¢è°¢å¤§å®¶~ ğŸŒ¸</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af50e747a22849e5a44ad1543f471f03~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="å›¾ç‰‡"></p>`,131);function o(m,g,u,E,y,v){const i=n("ArticleMetadata"),p=n("ClientOnly");return l(),t("div",null,[d,s(p,null,{default:r(()=>[s(i)]),_:1}),b])}const f=e(k,[["render",o]]);export{C as __pageData,f as default};
